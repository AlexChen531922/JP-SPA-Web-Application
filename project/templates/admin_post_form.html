{% extends "base.html" %}
{% block title %}{% if post %}編輯文章{% else %}撰寫文章{% endif %} - 管理後台{% endblock %}

{% block head %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/lang/summernote-zh-TW.min.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">

    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">管理後台</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard', tab='posts') }}">文章管理</a></li>
            <li class="breadcrumb-item active">{% if post %}編輯文章{% else %}撰寫文章{% endif %}</li>
        </ol>
    </nav>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <h3 class="fw-bold mb-4">
                <i class="bi bi-newspaper"></i> {% if post %}編輯文章{% else %}撰寫新文章{% endif %}
            </h3>

            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if post %}<input type="hidden" name="current_image" value="{{ post.image or '' }}">{% endif %}

                <div class="row g-4">

                    <div class="col-12">
                        <label class="form-label fw-bold">
                            文章標題 <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="title" class="form-control form-control-lg"
                            value="{{ post.title if post else '' }}" placeholder="輸入吸引人的標題..." required>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold">文章摘要</label>
                        <textarea name="summary" class="form-control" rows="3"
                            placeholder="簡短描述文章內容（建議 50-150 字）...">{{ post.summary if post else '' }}</textarea>
                        <small class="text-muted">此摘要將顯示在文章列表中</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">特色圖片</label>
                        <input type="file" name="image" class="form-control" accept="image/*" id="imageInput">
                        <small class="text-muted">建議尺寸：1200x630px，格式：JPG、PNG</small>

                        {% if post and post.image %}
                        <div class="mt-3">
                            {% if post.image and post.image.startswith('http') %}
                            <img src="{{ post.image }}" alt="Current image" class="img-thumbnail object-fit-cover"
                                style="max-width: 200px;"
                                onerror="this.src='{{ url_for('static', filename='img/default-post.png') }}'">
                            {% elif post.image %}
                            <img src="{{ url_for('static', filename='img/' + post.image) }}" alt="Current image"
                                class="img-thumbnail object-fit-cover" style="max-width: 200px;"
                                onerror="this.src='{{ url_for('static', filename='img/default-post.png') }}'">
                            {% endif %}
                        </div>
                        {% endif %}

                        <div id="imagePreview" class="mt-3" style="display:none;">
                            <img id="preview" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">發布狀態 <span class="text-danger">*</span></label>
                        <select name="status" class="form-select" required>
                            <option value="draft" {% if post and post.status=='draft' %}selected{% endif %}>
                                草稿 - 僅自己可見
                            </option>
                            <option value="published" {% if post and post.status=='published' %}selected{% elif not post
                                %}selected{% endif %}>
                                發布 - 公開顯示
                            </option>
                            <option value="archived" {% if post and post.status=='archived' %}selected{% endif %}>
                                封存 - 隱藏不顯示
                            </option>
                        </select>
                        <small class="text-muted">選擇「發布」將立即公開此文章</small>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold">
                            文章內容 <span class="text-danger">*</span>
                        </label>
                        <textarea id="contentEditor" name="content">{{ post.content if post else '' }}</textarea>
                    </div>

                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-lightbulb"></i> 撰寫建議
                            </h6>
                            <ul class="mb-0 small">
                                <li>使用清晰的標題和副標題組織內容</li>
                                <li>添加相關圖片增加文章吸引力</li>
                                <li>使用列表和段落使內容易於閱讀</li>
                                <li>包含內部連結到相關產品或課程</li>
                                <li>確保內容原創且有價值</li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr>
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{{ url_for('admin.dashboard', tab='posts') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                            <button type="submit" name="status" value="draft" class="btn btn-outline-primary">
                                <i class="bi bi-save"></i> 儲存草稿
                            </button>
                            <button type="submit" name="status" value="published" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {% if post and post.status == 'published' %}更新{% else
                                %}發布{% endif %}文章
                            </button>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // 初始化 Summernote 編輯器
    $(document).ready(function () {
        // 用變數追蹤內容是否有變更
        let contentChanged = false;

        $('#contentEditor').summernote({
            placeholder: '請在此輸入文章內容...',
            tabsize: 2,
            height: 600,                 // 編輯器高度
            lang: 'zh-TW',               // 設定繁體中文
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'video']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            callbacks: {
                // 圖片上傳回調：將圖片轉為 Base64 直接插入內容 (不依賴後端上傳 API)
                onImageUpload: function (files) {
                    for (let i = 0; i < files.length; i++) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            $('#contentEditor').summernote('insertImage', e.target.result);
                        };
                        reader.readAsDataURL(files[i]);
                    }
                },
                // 內容變更回調
                onChange: function (contents, $editable) {
                    contentChanged = true;
                }
            }
        });

        // 封面圖片預覽
        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // 表單提交驗證
        document.querySelector('form').addEventListener('submit', function (e) {
            const title = document.querySelector('[name="title"]').value.trim();

            // 取得 Summernote 的 HTML 內容
            const content = $('#contentEditor').summernote('code');
            // 檢查是否為空 (Summernote 空白時通常是 <p><br></p>)
            const isEmpty = $('#contentEditor').summernote('isEmpty');

            if (!title) {
                e.preventDefault();
                alert('請輸入文章標題');
                return false;
            }

            if (isEmpty || content.length < 10) {
                e.preventDefault();
                alert('請輸入文章內容');
                return false;
            }

            // 提交時重置變更狀態，避免觸發離開警告
            contentChanged = false;

            // 顯示 Loading
            const submitBtn = e.submitter;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';
        });

        // 離開頁面警告
        window.addEventListener('beforeunload', function (e) {
            if (contentChanged) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    });
</script>

<style>
    /* 修正 Summernote 在 Bootstrap 5 下的樣式微調 */
    .note-editor.note-frame {
        border-radius: 0.375rem;
        border-color: #dee2e6;
    }

    .alert-info {
        background-color: #e7f3ff;
        border-color: #b3d9ff;
        color: #004085;
    }
</style>
{% endblock %}