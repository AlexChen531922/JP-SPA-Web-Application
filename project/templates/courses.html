{% extends "base.html" %}
{% block title %}課程介紹 - 晶品芳療{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- Page Header -->
    <div class="text-center mb-4">
        <p class="lead text-muted">選擇適合您的芳療課程，讓身心得到完整的放鬆與療癒</p>
    </div>

    <!-- Search & Filter Section -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-4 g-3">

        <!-- Category Buttons (左側) -->


        <div class="row g-3 align-items-center mb-4">

            <div class="col-12 col-lg-auto me-auto">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('main.courses') }}"
                        class="btn btn-sm {% if not current_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        全部
                    </a>
                    {% for category in course_categories %}
                    <a href="{{ url_for('main.courses', category=category.id) }}"
                        class="btn btn-sm {% if current_category == category.id %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        {{ category.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <form method="GET" action="{{ url_for('main.courses') }}" class="input-group">
                    <input type="text" name="q" class="form-control form-control-sm me-2" placeholder="搜尋課程..."
                        value="{{ request.args.get('q', '') }}" aria-label="搜尋課程">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>

                    {% if search_query %}
                    <a href="{{ url_for('main.courses') }}" class="btn btn-outline-secondary" title="清除搜尋">
                        <i class="bi bi-x-lg"></i>
                    </a>
                    {% endif %}
                </form>
            </div>
        </div>

    </div>

    <!-- Course Grid -->
    <div class="row g-4" id="course-list">
        {% for course in courses %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card h-100 hover-zoom shadow-sm border-0 d-flex flex-column">

                <div data-bs-toggle="modal" data-bs-target="#courseModal{{ course.id }}"
                    class="d-flex flex-column flex-grow-1" style="cursor:pointer;">

                    <div class="ratio ratio-4x3 bg-light rounded-top overflow-hidden">
                        {% if course.image and course.image.startswith('http') %}
                        <img src="{{ course.image }}" class="w-100 h-100 object-fit-contain p-2" alt="{{ course.name }}"
                            loading="lazy"
                            onerror="this.src='{{ url_for('static', filename='img/default-course.png') }}'">
                        {% elif course.image %}
                        <img src="{{ url_for('static', filename='img/' + course.image) }}"
                            class="w-100 h-100 object-fit-contain p-2" alt="{{ course.name }}" loading="lazy"
                            onerror="this.src='{{ url_for('static', filename='img/default-course.png') }}'">
                        {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-image fs-1 opacity-25"></i>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-body d-flex flex-column p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                                {{ course.category_name or '精選課程' }}
                            </span>
                            {% if course.duration %}
                            <small class="text-muted"><i class="bi bi-clock"></i> {{ course.duration }} min</small>
                            {% endif %}
                        </div>

                        <h5 class="card-title fw-bold fs-6 mb-2 text-truncate">{{ course.name }}</h5>

                        <div class="mt-auto pt-2 border-top">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    {% if course.experience_price %}
                                    <span class="text-danger fw-bold d-block small">體驗 NT$ {{
                                        '{:,.0f}'.format(course.experience_price) }}</span>
                                    <small class="text-decoration-line-through text-muted"
                                        style="font-size: 0.8rem;">NT$ {{ '{:,.0f}'.format(course.regular_price)
                                        }}</small>
                                    {% else %}
                                    <span class="text-primary fw-bold">NT$ {{ '{:,.0f}'.format(course.regular_price)
                                        }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-white border-0 pt-0 pb-3">
                    {% if session.get('user', {}).get('role') in ['customer', 'admin', 'staff'] %}
                    <a href="{{ url_for('main.course_detail', course_id=course.id) }}"
                        class="btn btn-success btn-sm w-100 rounded-pill">
                        <i class="bi bi-calendar-week"></i> 選擇預約時段
                    </a>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}"
                        class="btn btn-outline-secondary btn-sm w-100 rounded-pill">請先登入</a>
                    {% endif %}
                </div>

            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <div class="text-muted">
                <i class="bi bi-search fs-1 d-block mb-3"></i>
                <p>沒有找到相關課程</p>
            </div>
        </div>
        {% endfor %}
    </div>

    {% for course in courses %}
    <div class="modal fade" id="courseModal{{ course.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">{{ course.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3 bg-light rounded p-2">
                        {% if course.image and course.image.startswith('http') %}
                        <img src="{{ course.image }}" class="img-fluid rounded"
                            style="max-height: 400px; object-fit: contain;" alt="{{ course.name }}">
                        {% elif course.image %}
                        <img src="{{ url_for('static', filename='img/' + course.image) }}" class="img-fluid rounded"
                            style="max-height: 400px; object-fit: contain;" alt="{{ course.name }}">
                        {% endif %}
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <p class="mb-1 text-muted small">課程類別</p>
                            <p class="fw-bold">{{ course.category_name or '一般課程' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1 text-muted small">所需時間</p>
                            <p class="fw-bold">{{ course.duration or '--' }} 分鐘</p>
                        </div>
                        <div class="col-12">
                            <p class="mb-1 text-muted small">課程價格</p>
                            {% if course.experience_price %}
                            <span class="text-danger fw-bold fs-5 me-2">體驗價 NT$ {{
                                '{:,.0f}'.format(course.experience_price) }}</span>
                            <span class="text-decoration-line-through text-muted">原價 NT$ {{
                                '{:,.0f}'.format(course.regular_price) }}</span>
                            {% else %}
                            <span class="text-primary fw-bold fs-5">NT$ {{ '{:,.0f}'.format(course.regular_price)
                                }}</span>
                            {% endif %}
                        </div>

                        {% if course.description %}
                        <div class="col-12">
                            <hr>
                            <p class="mb-1 text-muted small">課程介紹</p>
                            <div class="text-secondary" style="white-space: pre-line;">{{ course.description }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">關閉</button>
                    <a href="{{ url_for('main.course_detail', course_id=course.id) }}"
                        class="btn btn-primary rounded-pill px-4">
                        前往預約
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <div id="loading-indicator" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="no-more-courses" class="text-center py-4 text-muted small" style="display: none;">
        沒有更多課程了
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    let page = 1;
    let loading = false;
    let hasMore = true;
    const categoryId = "{{ current_category or '' }}";
    const searchQuery = "{{ request.args.get('q', '') }}";

    // Infinite scroll
    function loadMoreCourses() {
        if (loading || !hasMore) return;

        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loading = true;
            document.getElementById('loading-indicator').style.display = 'block';

            page++;
            let url = `{{ url_for('main.courses') }}?page=${page}`;
            if (categoryId) url += `&category=${categoryId}`;
            if (searchQuery) url += `&q=${searchQuery}`;

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.text())
                .then(html => {
                    const loadingIndicator = document.getElementById('loading-indicator');
                    const noMoreIndicator = document.getElementById('no-more-courses');
                    loadingIndicator.style.display = 'none';

                    if (html.trim()) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        // 這裡要注意：要同時抓取新的卡片和新的 Modal
                        const newItems = doc.querySelectorAll('.col-6');
                        const newModals = doc.querySelectorAll('.modal');

                        if (newItems.length > 0) {
                            const courseList = document.getElementById('course-list');
                            newItems.forEach(item => courseList.appendChild(item));
                            // 將新的 Modal 加到 body 或列表後方
                            newModals.forEach(modal => courseList.appendChild(modal));
                            loading = false;
                        } else {
                            hasMore = false;
                            noMoreIndicator.style.display = 'block';
                        }
                    } else {
                        hasMore = false;
                        noMoreIndicator.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('載入失敗:', err);
                    document.getElementById('loading-indicator').style.display = 'none';
                    loading = false;
                });
        }
    }

    if (hasMore) {
        window.addEventListener('scroll', loadMoreCourses);
    }
</script>

<style>
    .hover-zoom {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hover-zoom:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
    }

    .object-fit-cover {
        object-fit: cover;
    }
</style>
{% endblock %}