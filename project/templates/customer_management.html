{% extends "base.html" %}
{% block title %}會員中心 - 晶品芳療{% endblock %}

{% block content %}
<div class="container py-4">

  <h2 class="fw-bold mb-4"><i class="bi bi-person-circle"></i> 會員中心</h2>

  <div class="row g-4">

    <!-- Left Sidebar -->
    <div class="col-md-3">
      <div class="list-group sticky-top" style="top: 100px;">
        <a href="{{ url_for('customer.dashboard') }}" class="list-group-item list-group-item-action active">
          <i class="bi bi-speedometer2"></i> 儀表板
        </a>
        <a href="{{ url_for('customer.bookings') }}" class="list-group-item list-group-item-action">
          <i class="bi bi-calendar-check"></i> 我的預約
        </a>
        <a href="{{ url_for('customer.orders') }}" class="list-group-item list-group-item-action">
          <i class="bi bi-bag-check"></i> 我的訂單
        </a>
        <a href="#profileModal" data-bs-toggle="modal" class="list-group-item list-group-item-action">
          <i class="bi bi-person-gear"></i> 個人資料
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">

      <!-- Welcome Card -->
      <div class="card bg-primary text-white mb-4">
        <div class="card-body">
          <h4 class="fw-bold mb-2">歡迎回來，{{ user.firstname }} {{ user.surname }}！</h4>
          <p class="mb-0">很高興再次見到您</p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <i class="bi bi-calendar-check fs-1 text-primary"></i>
              <h3 class="fw-bold mt-2">{{ active_courses|length }}</h3>
              <p class="text-muted mb-0">有效課程</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <i class="bi bi-bag-check fs-1 text-success"></i>
              <h3 class="fw-bold mt-2">{{ recent_orders|length }}</h3>
              <p class="text-muted mb-0">最近訂單</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center">
            <div class="card-body">
              <i class="bi bi-box fs-1 text-warning"></i>
              <h3 class="fw-bold mt-2">{{ purchased_products|length }}</h3>
              <p class="text-muted mb-0">已購產品</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Courses -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-calendar-check"></i> 我的課程
          </h5>
        </div>
        <div class="card-body">
          {% if active_courses %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>課程名稱</th>
                  <th>已購堂數</th>
                  <th>剩餘堂數</th>
                  <th>預約日期</th>
                </tr>
              </thead>
              <tbody>
                {% for course in active_courses %}
                <tr>
                  <td>{{ course.course_name }}</td>
                  <td>{{ course.sessions_purchased }}</td>
                  <td>
                    <span class="badge bg-success">{{ course.sessions_remaining }} 堂</span>
                  </td>
                  <td>{{ course.created_at.strftime('%Y-%m-%d') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <a href="{{ url_for('customer.bookings') }}" class="btn btn-sm btn-outline-primary">
            查看全部預約 <i class="bi bi-arrow-right"></i>
          </a>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-calendar-x fs-1 text-muted"></i>
            <p class="text-muted mt-2">目前沒有有效課程</p>
            <a href="{{ url_for('main.courses') }}" class="btn btn-primary">
              <i class="bi bi-calendar-plus"></i> 預約課程
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-bag-check"></i> 最近訂單
          </h5>
        </div>
        <div class="card-body">
          {% if recent_orders %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>訂單編號</th>
                  <th>商品數量</th>
                  <th>金額</th>
                  <th>狀態</th>
                  <th>日期</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for order in recent_orders %}
                <tr>
                  <td>#{{ order.id }}</td>
                  <td>{{ order.item_count }} 項</td>
                  <td>NT$ {{ '{:,.0f}'.format(order.total_amount) }}</td>
                  <td>
                    {% if order.status == 'pending' %}
                    <span class="badge bg-warning">待確認</span>
                    {% elif order.status == 'confirmed' %}
                    <span class="badge bg-info">已確認</span>
                    {% elif order.status == 'completed' %}
                    <span class="badge bg-success">已完成</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ order.status }}</span>
                    {% endif %}
                  </td>
                  <td>{{ order.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <a href="{{ url_for('customer.order_detail', order_id=order.id) }}"
                      class="btn btn-sm btn-outline-primary">
                      查看
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <a href="{{ url_for('customer.orders') }}" class="btn btn-sm btn-outline-primary">
            查看全部訂單 <i class="bi bi-arrow-right"></i>
          </a>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-bag-x fs-1 text-muted"></i>
            <p class="text-muted mt-2">目前沒有訂單記錄</p>
            <a href="{{ url_for('main.products') }}" class="btn btn-primary">
              <i class="bi bi-bag-plus"></i> 開始購物
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Purchased Products -->
      {% if purchased_products %}
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-box"></i> 已購產品
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>產品名稱</th>
                  <th>購買數量</th>
                </tr>
              </thead>
              <tbody>
                {% for product in purchased_products %}
                <tr>
                  <td>{{ product.name }}</td>
                  <td>{{ product.total_quantity }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>

</div>

<!-- Profile Edit Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">編輯個人資料</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('customer.update_profile') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">姓氏</label>
            <input type="text" name="surname" class="form-control" value="{{ user.surname }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">名字</label>
            <input type="text" name="firstname" class="form-control" value="{{ user.firstname }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">電話</label>
            <input type="tel" name="phone" class="form-control" value="{{ user.phone or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">LINE ID</label>
            <input type="text" name="line_id" class="form-control" value="{{ user.line_id or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">地址</label>
            <textarea name="address" class="form-control" rows="2">{{ user.address or '' }}</textarea>
          </div>
          <hr>
          <div class="mb-3">
            <label class="form-label">新密碼（不修改請留空）</label>
            <input type="password" name="password" class="form-control">
            <small class="text-muted">至少 6 個字元</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">儲存變更</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}