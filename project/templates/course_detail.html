{% extends "base.html" %}

{% block head %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<style>
    /* 行事曆容器 */
    #calendar {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        min-height: 500px;
    }

    /* 修改原有的 .fc-event 樣式 */
    .fc-event {
        cursor: pointer !important;
        border: none !important;
        margin: 1px !important;
        /* 留一點縫隙 */
        border-radius: 6px !important;
        /* 圓角 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        overflow: hidden;
        /* 防止內容溢出 */
    }

    /* 讓週視圖的時間格子稍微高一點，才不會太擠 */
    .fc-timegrid-slot {
        height: 3em !important;
    }

    .fc-event:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* 可預約狀態 (綠色) */
    .status-available {
        background-color: #28a745 !important;
        /* Green */
        color: white !important;
    }

    /* 已額滿狀態 (紅色) */
    .status-full {
        background-color: #dc3545 !important;
        /* Red */
        color: white !important;
        opacity: 0.7;
        cursor: not-allowed !important;
    }

    /* 今天的背景色 */
    .fc-day-today {
        background-color: rgba(255, 240, 245, 0.5) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row g-5">
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 100px;">
                <h2 class="fw-bold mb-3">{{ course.name }}</h2>
                {% if course.image %}
                <img src="{{ url_for('static', filename=course.image) }}"
                    class="img-fluid rounded-4 shadow-sm mb-4 w-100 object-fit-cover" style="max-height: 250px;">
                {% endif %}

                <div class="card border-0 bg-light rounded-4 mb-4">
                    <div class="card-body">
                        <h5 class="fw-bold"><i class="bi bi-info-circle-fill text-primary"></i> 預約說明</h5>
                        <p class="mb-2">{{ course.description }}</p>
                        <hr>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="bi bi-clock text-muted"></i> 時長：{{ course.duration }} 分鐘</li>
                            <li class="mb-2"><i class="bi bi-currency-dollar text-muted"></i> 價格：NT$ {{
                                '{:,.0f}'.format(course.regular_price) }}</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-primary d-flex align-items-center" role="alert">
                    <i class="bi bi-hand-index-thumb-fill fs-4 me-3"></i>
                    <div>
                        <strong>如何預約？</strong><br>
                        請點擊右側日曆上的 <span class="badge bg-success">綠色時段</span> 即可預約。
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div id='calendar'></div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{{ url_for('main.book_course_slot') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="hidden" name="schedule_id" id="modalScheduleId">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> 確認預約</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <h4 class="text-primary fw-bold mb-3">{{ course.name }}</h4>
                    <p class="fs-5">您選擇的時段為：</p>
                    <div class="bg-light p-3 rounded-3 d-inline-block mb-3">
                        <strong id="modalTimeStr" class="fs-4"></strong>
                    </div>
                    <p class="text-muted mb-0">確定要預約此時段嗎？</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">再想想</button>
                    <button type="submit" class="btn btn-primary px-4">確定預約</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var initialView = window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek'; // 電腦版改預設週視圖比較清楚

        var calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error("找不到 id='calendar' 的 HTML 元素");
            return;
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },

            // --- ⭐ 版面優化設定開始 ---
            allDaySlot: false,        // 1. 移除上方全天欄位 (增加垂直空間)
            slotEventOverlap: false,  // 2. 禁止事件重疊 (解決階梯狀堆疊問題)
            slotDuration: '00:30:00', // 設定時間格線間隔
            slotLabelInterval: '01:00', // 設定時間標籤間隔
            expandRows: true,         // 讓行高自動延展填滿高度
            displayEventTime: false,  // 3. 隱藏預設的時間文字 (減少雜訊)
            height: 'auto',
            contentHeight: 'auto',
            // --- 版面優化設定結束 ---

            // 加入視窗縮放監聽
            windowResize: function (view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                } else {
                    calendar.changeView('timeGridWeek');
                }
            },

            locale: 'zh-tw',
            navLinks: true,
            businessHours: {
                daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
                startTime: '09:00',
                endTime: '21:00',
            },

            // 資料來源
            events: '/api/course/{{ course.id }}/schedule',

            // ⭐ 4. 自定義事件顯示內容 (讓卡片變整齊的關鍵)
            eventContent: function (arg) {
                let isFull = arg.event.extendedProps.isFull;
                let title = arg.event.title;
                // 嘗試從 title 取出剩餘人數 (假設格式為 "可預約 (5)")
                let remaining = title.match(/\((\d+)\)/);
                let count = remaining ? remaining[1] : '?';

                let icon = isFull ? '<i class="bi bi-x-circle"></i>' : '<i class="bi bi-check-circle"></i>';
                let text = isFull ? '已額滿' : `剩 ${count} 位`;

                // 回傳自定義的 HTML 結構
                return {
                    html: `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 w-100">
                            <div class="fw-bold" style="font-size: 0.9rem;">${icon} ${isFull ? '額滿' : '預約'}</div>
                            <div class="small opacity-75">${isFull ? '' : '名額:' + count}</div>
                        </div>
                    `
                };
            },

            // 點擊事件
            eventClick: function (info) {
                if (info.event.extendedProps.isFull) {
                    alert('抱歉，該時段已額滿，請選擇其他時段。');
                    return;
                }
                document.getElementById('modalTimeStr').textContent = info.event.extendedProps.dateStr;
                document.getElementById('modalScheduleId').value = info.event.extendedProps.scheduleId;

                var modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            },

            // 滑鼠懸停效果
            eventMouseEnter: function (info) {
                info.el.style.cursor = 'pointer';
                info.el.style.opacity = '0.9';
            },
            eventMouseLeave: function (info) {
                info.el.style.opacity = '1';
            }
        });
        calendar.render();
    });
</script>
{% endblock %}