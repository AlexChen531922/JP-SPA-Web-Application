{% extends "base.html" %}

{% block head %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<style>
    /* 行事曆容器 */
    #calendar {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        min-height: 600px;
    }

    /* --- 針對「週檢視 (TimeGrid)」的樣式優化 --- */

    /* 讓事件變成細長的橫條，文字不換行 */
    .fc-timegrid-event {
        border-radius: 4px !important;
        padding: 2px 4px !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: none !important;
        /* 關鍵：強制文字水平排列，不換行 */
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        white-space: nowrap !important;
        overflow: hidden !important;
    }

    /* 調整時間文字與標題的間距 */
    .fc-event-time {
        font-size: 0.85em;
        margin-right: 5px;
        font-weight: normal;
    }

    .fc-event-title {
        font-weight: bold;
        font-size: 0.9em;
    }

    /* 讓週檢視的時間格子稍微高一點，視覺比較不擁擠 */
    .fc-timegrid-slot {
        height: 3.5em !important;
    }

    /* --- 滑鼠互動效果 --- */
    .fc-event:hover {
        opacity: 0.9;
        cursor: pointer;
        transform: scale(1.01);
        /* 微微放大就好，不要太誇張 */
        transition: all 0.2s;
    }

    /* 今天的背景色 */
    .fc-day-today {
        background-color: rgba(255, 240, 245, 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row g-5">
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 100px;">
                <h2 class="fw-bold mb-3">{{ course.name }}</h2>
                {% if course.image %}
                <img src="{{ url_for('static', filename=course.image) }}"
                    class="img-fluid rounded-4 shadow-sm mb-4 w-100 object-fit-cover" style="max-height: 250px;">
                {% endif %}

                <div class="card border-0 bg-light rounded-4 mb-4">
                    <div class="card-body">
                        <h5 class="fw-bold"><i class="bi bi-info-circle-fill text-primary"></i> 預約說明</h5>
                        <p class="mb-2">{{ course.description }}</p>
                        <hr>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="bi bi-clock text-muted"></i> 時長：{{ course.duration }} 分鐘</li>
                            <li class="mb-2"><i class="bi bi-currency-dollar text-muted"></i> 價格：NT$ {{
                                '{:,.0f}'.format(course.regular_price) }}</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-primary d-flex align-items-center" role="alert">
                    <i class="bi bi-hand-index-thumb-fill fs-4 me-3"></i>
                    <div>
                        <strong>如何預約？</strong><br>
                        請點擊右側日曆上的 <span class="badge bg-success">綠色時段</span> 即可預約。
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-0">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{{ url_for('main.book_course_slot') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="hidden" name="schedule_id" id="modalScheduleId">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> 確認預約</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <h4 class="text-primary fw-bold mb-3">{{ course.name }}</h4>
                    <p class="fs-5">您選擇的時段為：</p>
                    <div class="bg-light p-3 rounded-3 d-inline-block mb-3">
                        <strong id="modalTimeStr" class="fs-4"></strong>
                    </div>
                    <p class="text-muted mb-0">確定要預約此時段嗎？</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">再想想</button>
                    <button type="submit" class="btn btn-primary px-4">確定預約</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var initialView = window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek';

        var calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error("找不到 id='calendar' 的 HTML 元素");
            return;
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },

            // --- 樣式設定 ---
            allDaySlot: false,        // 移除全天欄位
            slotEventOverlap: false,  // 禁止重疊

            // ⭐ 關鍵設定：強制視覺上只顯示 30 分鐘的高度
            // 這樣即便課程是 90 分鐘，在日曆上也只會顯示一個細細的橫條，不會填滿格子
            forceEventDuration: true,
            defaultTimedEventDuration: '00:30',

            displayEventTime: false,  // 隱藏預設的時間 (例如 9:00a)，讓畫面更乾淨

            height: 'auto',
            contentHeight: 'auto',
            locale: 'zh-tw',
            navLinks: true,
            businessHours: {
                daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
                startTime: '09:00',
                endTime: '21:00',
            },

            // 資料來源
            events: '/api/course/{{ course.id }}/schedule',

            // ⭐ 這裡移除了 eventContent，這樣「月檢視」和「清單檢視」就會變回原本的圓點/列表樣式

            // 點擊事件
            eventClick: function (info) {
                // 檢查是否額滿 (從 API 回傳的 extendedProps 判斷)
                if (info.event.extendedProps.isFull) {
                    alert('抱歉，該時段已額滿，請選擇其他時段。');
                    return;
                }
                document.getElementById('modalTimeStr').textContent = info.event.extendedProps.dateStr;
                document.getElementById('modalScheduleId').value = info.event.extendedProps.scheduleId;

                var modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            },

            windowResize: function (view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                } else {
                    calendar.changeView('timeGridWeek');
                }
            }
        });
        calendar.render();
    });
</script>
{% endblock %}