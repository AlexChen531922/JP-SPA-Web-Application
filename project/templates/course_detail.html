{% extends "base.html" %}

{% block head %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<style>
    /* 行事曆容器 */
    #calendar {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        min-height: 500px;
    }



    /* 強制修改 FullCalendar 事件樣式，讓它看起來像可點擊的按鈕 */
    .fc-event {
        cursor: pointer !important;
        border: none !important;
        padding: 5px !important;
        margin-bottom: 2px !important;
        text-align: center;
        border-radius: 4px !important;
        transition: transform 0.1s, box-shadow 0.1s;
    }

    .fc-event:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* 可預約狀態 (綠色) */
    .status-available {
        background-color: #28a745 !important;
        /* Green */
        color: white !important;
    }

    /* 已額滿狀態 (紅色) */
    .status-full {
        background-color: #dc3545 !important;
        /* Red */
        color: white !important;
        opacity: 0.7;
        cursor: not-allowed !important;
    }

    /* 今天的背景色 */
    .fc-day-today {
        background-color: rgba(255, 240, 245, 0.5) !important;
    }

    /* ...保留原本的樣式... */

    /* 1. 強制日期標題不換行 */
    .fc-col-header-cell-cushion {
        white-space: nowrap !important;
        /* 禁止換行 */
        display: inline-block !important;
        font-size: 0.95rem;
        /* 稍微縮小字體以防過寬 */
        padding: 5px 2px !important;
    }

    /* 2. 調整事件內容樣式，確保文字居中且不被裁切 */
    .fc-event-main-frame {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 !important;
        /* 移除內距以爭取空間 */
    }

    .fc-event-title {
        white-space: nowrap !important;
        font-size: 1rem;
        /* 字體大小 */
        line-height: 1;
    }
</style>
{% endblock %}

{% block title %}{{ course.name }} - 課程預約{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.courses') }}" class="text-decoration-none">課程列表</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ course.name }}</li>
        </ol>
    </nav>

    <div class="row g-5">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                <div class="ratio ratio-4x3 course-image-container">
                    {% if course.image and course.image.startswith('http') %}
                    <img src="{{ course.image }}" alt="{{ course.name }}"
                        onerror="this.src='{{ url_for('static', filename='img/default-course.png') }}'">
                    {% elif course.image %}
                    <img src="{{ url_for('static', filename='img/' + course.image) }}" alt="{{ course.name }}"
                        onerror="this.src='{{ url_for('static', filename='img/default-course.png') }}'">
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center w-100 h-100 text-muted">
                        <i class="bi bi-image fs-1"></i>
                    </div>
                    {% endif %}
                </div>

                <div class="card-body p-4">
                    <h2 class="fw-bold mb-3">{{ course.name }}</h2>
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge bg-primary me-2">{{ course.category_name or '精選課程' }}</span>
                        <span class="text-muted"><i class="bi bi-clock"></i> {{ course.duration }} 分鐘</span>
                    </div>

                    <div class="mb-4">
                        {% if course.experience_price %}
                        <h4 class="text-danger fw-bold mb-0">體驗價 NT$ {{ '{:,.0f}'.format(course.experience_price) }}
                        </h4>
                        <small class="text-muted text-decoration-line-through">原價 NT$ {{
                            '{:,.0f}'.format(course.regular_price) }}</small>
                        {% else %}
                        <h4 class="text-primary fw-bold">NT$ {{ '{:,.0f}'.format(course.regular_price) }}</h4>
                        {% endif %}
                    </div>

                    <h5 class="fw-bold mb-2">課程內容</h5>
                    <p class="text-muted" style="white-space: pre-line;">{{ course.description or '暫無詳細描述' }}</p>
                </div>
            </div>

            <div class="alert alert-info d-lg-none">
                <i class="bi bi-info-circle-fill me-2"></i> 請往下滑動選擇預約時段
            </div>
        </div>

        <div class="col-lg-7">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0">選擇預約時段</h4>

                {% if not session.get('user') %}
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-exclamation-circle"></i> 請先登入以進行預約
                </span>
                {% endif %}
            </div>

            <div id='calendar'></div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">確認預約資訊</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('main.book_course', course_id=course.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="schedule_id" id="modalScheduleId">

                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="text-muted small">預約課程</label>
                        <div class="fw-bold fs-5">{{ course.name }}</div>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small">預約時段</label>
                        <div class="fw-bold fs-5 text-primary" id="modalTimeStr"></div>
                    </div>

                    <div class="alert alert-light border small">
                        <i class="bi bi-info-circle me-1"></i>
                        預約送出後，我們將盡快與您聯繫確認。
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">取消</button>
                    {% if session.get('user') %}
                    <button type="submit" class="btn btn-primary rounded-pill px-4">確認預約</button>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}" class="btn btn-warning rounded-pill px-4">請先登入</a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
            locale: 'zh-tw',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            buttonText: {
                today: '今天',
                month: '月',
                week: '週',
                list: '列表'
            },
            // 設定顯示範圍 (只能看未來 30 天)
            validRange: {
                start: new Date().toISOString().split('T')[0],
                end: new Date(new Date().setDate(new Date().getDate() + 60)).toISOString().split('T')[0]
            },
            // 隱藏非營業時間 (僅顯示 10:00 - 20:00)
            slotMinTime: '10:00',
            slotMaxTime: '20:00',
            allDaySlot: false,

            // RWD: 視窗縮放時切換視圖
            windowResize: function (view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                } else {
                    if (view.type === 'listWeek') {
                        calendar.changeView('dayGridMonth');
                    }
                }
            },

            // 資料來源 API
            events: '/api/course/{{ course.id }}/schedule',

            // 點擊事件
            eventClick: function (info) {
                // 1. 額滿檢查
                if (info.event.extendedProps.isFull) {
                    alert('抱歉，該時段已額滿，請選擇其他時段。');
                    return;
                }

                // 2. 填入 Modal 並顯示
                document.getElementById('modalTimeStr').textContent = info.event.extendedProps.dateStr;
                document.getElementById('modalScheduleId').value = info.event.extendedProps.scheduleId;

                var modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            },

            // 滑鼠懸停效果
            eventMouseEnter: function (info) {
                if (!info.event.extendedProps.isFull) {
                    info.el.style.transform = 'scale(1.05)';
                    info.el.style.transition = '0.2s';
                }
            },
            eventMouseLeave: function (info) {
                info.el.style.transform = 'scale(1.0)';
            },

            // 渲染事件內容
            // 渲染事件內容
            eventContent: function (arg) {
                let statusClass = arg.event.extendedProps.isFull ? 'status-full' : 'status-available';
                let statusText = arg.event.extendedProps.isFull ? '額滿' : '可預約';

                // 針對 "週視圖" (timeGrid) 的顯示優化
                if (arg.view.type === 'timeGridWeek') {
                    return {
                        html: `<div class="fc-event-main-frame ${statusClass} rounded h-100 w-100 d-flex justify-content-center align-items-center">
                                 <div class="fc-event-title fw-bold">${statusText}</div>
                               </div>`
                    };
                }

                // 針對 "月視圖" 或 "列表" 的顯示 (保持原樣或一併修改)
                return {
                    html: `<div class="fc-event-main-frame ${statusClass} rounded p-1">
                             <div class="fc-event-time small">${arg.timeText}</div>
                             <div class="fc-event-title fw-bold">${statusText}</div>
                           </div>`
                };
            }
        });
        calendar.render();
    });
</script>
{% endblock %}