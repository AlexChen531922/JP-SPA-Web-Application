{% extends "base.html" %}
{% block title %}課程列表{% endblock %}

{% block content %}
<div class="container-xxl py-4">

  <!-- 分類 bar -->
  <div class="mb-4 d-flex flex-wrap gap-2">
    <button class="btn btn-category active" data-category="all">全部</button>
    {% for series in series_list %}
    <button class="btn btn-category" data-category="{{ series.id }}">{{ series.name }}</button>
    {% endfor %}
  </div>

  <!-- 課程清單 -->
  <div id="course-list" class="row g-3">
    {% for course in courses %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 hover-zoom">
        <div class="ratio ratio-4x3">
          <img src="{{ url_for('static', filename=course.image_url) }}" class="w-100 h-100 object-fit-cover"
            alt="{{ course.name }}">
        </div>
        <div class="card-body d-flex flex-column">
          <h6 class="text-truncate">{{ course.name }}</h6>

          <!-- 課程價格 -->
          {% if course.first_time %}
          <span class="badge text-bg-success">首次體驗 ${{ '%.2f'|format(course.experience_price) }}</span>
          {% else %}
          <span class="badge text-bg-light">${{ '%.2f'|format(course.price) }}</span>
          {% endif %}

          <!-- 選擇堂數 -->
          {% if session.get('role') == 'customer' %}
          <form action="{{ url_for('booking.add') }}" method="POST" class="mt-auto">
            <input type="hidden" name="course_id" value="{{ course.id }}">
            <div class="mb-2">
              <label for="quantity-{{ course.id }}" class="form-label small">堂數</label>
              <input type="number" id="quantity-{{ course.id }}" name="quantity" min="1" value="1" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary w-100">預約課程</button>
          </form>
          {% else %}
          <button class="btn btn-secondary w-100 mt-auto" disabled>請先登入</button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="loading" class="text-center mt-3" style="display:none;">
    <span class="text-muted">載入中...</span>
  </div>
</div>

<script>
  let page = 1;
  let loading = false;
  const courseList = document.getElementById('course-list');
  const loadingIndicator = document.getElementById('loading');

  // infinite scroll
  const loadMoreCourses = () => {
    if (loading) return;
    const scrollTop = window.scrollY;
    const windowHeight = window.innerHeight;
    const docHeight = document.body.scrollHeight;

    if (scrollTop + windowHeight >= docHeight - 300) {
      loading = true;
      page += 1;
      loadingIndicator.style.display = 'block';
      const category = document.querySelector('.btn-category.active').dataset.category;

      fetch(`/courses?page=${page}&category=${category}`)
        .then(res => res.text())
        .then(html => {
          if (html.trim()) {
            courseList.insertAdjacentHTML('beforeend', html);
            loading = false;
            loadingIndicator.style.display = 'none';
          } else {
            window.removeEventListener('scroll', scrollHandler);
            loadingIndicator.innerHTML = '<span class="text-muted">已載入全部</span>';
          }
        });
    }
  };

  const scrollHandler = () => loadMoreCourses();
  window.addEventListener('scroll', scrollHandler);

  // 分類切換
  document.querySelectorAll('.btn-category').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.btn-category').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const category = btn.dataset.category;
      fetch(`/courses?page=1&category=${category}`)
        .then(res => res.text())
        .then(html => {
          courseList.innerHTML = html;
          page = 1;
          window.addEventListener('scroll', scrollHandler);
        });
    });
  });
</script>
{% endblock %}