{% extends "base.html" %}

{% block title %}
{% if current_user_role == 'vendor' %}Vendor Management Page{% else %}Admin Management Page{% endif %}
{% endblock %}

{% block content %}
<main class="py-4">
  <div class="container-fluid">

    <form method="POST" enctype="multipart/form-data" class="row g-3 align-items-stretch" novalidate>
      {{ form.csrf_token }}
      <input type="hidden" name="action" value="add_image">

      <div class="col-12 col-xl-5 d-flex">
        <div class="rounded-4 border border-secondary-subtle flex-fill dz-wrap">
          <label for="imageInput"
            class="d-flex flex-column justify-content-center align-items-center w-100 h-100 p-4 dz-border dz-minh"
            style="border-width: 0.5px; min-height: 420px; cursor: pointer">
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="gray" class="bi bi-cloud-arrow-up"
              viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd"
                d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708z" />
              <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773
                       16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223
                       2.942-3.593.143-.863.698-1.723 1.464-2.383m.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049
                       C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773
                       c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z" />
            </svg>
            <h4 class="form-text px-3">Click the area to choose a file.</h4>
            <div class="form-text px-3 pb-3">Allowed: jpg, jpeg, png, webp, gif (≤5MB)</div>
            {{ form.image(id='imageInput', class='d-none', accept='image/*', required=True) }}
            <div class="dz-ready text-success fw-semibold px-3 py-2" style="display:none">
              ✅ Image selected and ready
            </div>
          </label>
          
          {% if form.image.errors %}
          <div class="text-danger small px-3 py-2">{{ form.image.errors[0] }}</div>
          {% endif %}
        </div>
      </div>

      <div class="col-12 col-xl-7 d-flex">
        <div class="card rounded-4 flex-fill h-100">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold">Title</label>
                {% if form.title.errors %}
                {{ form.title(class="form-control is-invalid", placeholder="Image title", autofocus=True) }}
                <div class="invalid-feedback">{{ form.title.errors[0] }}</div>
                {% else %}
                {{ form.title(class="form-control", placeholder="Image title") }}
                {% endif %}
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold">Description</label>
                {{ form.description(class="form-control", rows="3", placeholder="Image description") }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Event</label>
                {{ form.event_id(class="form-select") }}
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-semibold">Categories</label>

                <div class="row row-cols-2 row-cols-md-3 g-2">
                  {% for c in category_list %}
                    <div class="col">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          name="category_ids"
                          id="cat-{{ c.id }}"
                          value="{{ c.id }}"
                          {% if form.category_ids.data and c.id in form.category_ids.data %}checked{% endif %}
                        >
                        <label class="form-check-label" for="cat-{{ c.id }}">{{ c.name }}</label>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                {% for error in form.category_ids.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold">License</label>
                {{ form.license_id(class="form-select") }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Resolution</label>
                {{ form.resolution(class="form-select") }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Format</label>
                {{ form.format(class="form-select") }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Price</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ form.price(class="form-control", min="0", step="0.01", placeholder="5.99", value="5.99") }}
                </div>
              </div>

              <div class="col-12">
                {{ form.submit(class="btn btn-dark w-100") }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div class="table-responsive mt-4">
      {% if current_user_role == 'admin' %}
      <ul class="nav nav-pills gap-2"
        style="--bs-nav-pills-link-active-bg:#000; --bs-nav-pills-link-active-color:#fff; --bs-nav-link-color:#555;">
        <li class="nav-item">
          <a class="nav-link {{ 'active' if tab=='images' else '' }}"
            href="{{ url_for('main.vendor_management', tab='images') }}">Images</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{ 'active' if tab=='users' else '' }}"
            href="{{ url_for('main.vendor_management', tab='users') }}">Users</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{ 'active' if tab=='orders' else '' }}"
            href="{{ url_for('main.vendor_management', tab='orders') }}">Orders</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{ 'active' if tab=='events' else '' }}"
            href="{{ url_for('main.vendor_management', tab='events') }}">Events</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{ 'active' if tab=='categories' else '' }}"
            href="{{ url_for('main.vendor_management', tab='categories') }}">Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{ 'active' if tab=='licenses' else '' }}"
            href="{{ url_for('main.vendor_management', tab='licenses') }}">Licenses</a>
        </li>
      </ul>

      {% if tab == 'images' %}
      <table class="table table-striped align-middle mt-3">
        <thead>
          <tr>
            <th>Title</th>
            <th>ID</th>
            <th>Vendor</th>
            <th>Price</th>
            <th>Format</th>
            <th>Resolution</th>
            <th>Event</th>
            <th>Category</th>
            <th>License</th>
            <th>Uploaded</th>
            <th class="text-end">Action</th>
          </tr>
        </thead>
       <tbody>
          {% for img in images %}
          <tr>
            <td>
              <div class="d-flex align-items-center gap-1">
                <div class="flex-shrink-0" style="width:40px;height:30px">
                  <img src="{{ url_for('static', filename=img.url) }}"
                      class="w-100 h-100 object-fit-contain d-block"
                      alt="{{ img.title }}">
                </div>
                <p class="fw-semibold mb-0 ms-1 text-truncate">{{ img.title }}</p>
              </div>
            </td>

            <td>{{ img.id }}</td>
            <td>{{ img.vendor_name or '-' }}</td>

            <td>{{ '%.2f'|format(img.price or 0) }}</td>
            <td class="text-uppercase text-center"><span class="badge text-bg-light">{{ img.format }}</span></td>
            <td><span class="badge text-bg-light">{{ img.resolution }}</span></td>

            <td class="text-center">
              <span class="badge badge-event">{{ img.event_name or '-' }}</span>
            </td>

            <td class="text-center">
              {% if img.category_names %}
                {% for category in img.category_names %}
                  <span class="badge badge-category">#{{ category }}</span>
                {% endfor %}
              {% else %}—{% endif %}
            </td>

            <td class="text-center">
              {% if img.license_types %}
                <span class="badge text-bg-dark">{{ img.license_types|join(', ') }}</span>
              {% else %}—{% endif %}
            </td>

            <td>{{ img.uploaded_at }}</td>

            <td class="text-end">
              <div class="d-flex justify-content-end align-items-center gap-2 flex-wrap">
                <a class="btn btn-outline-secondary btn-sm"
                  href="{{ url_for('vendor.edit', image_id=img.id) }}">
                  Edit
                </a>

                <form method="post" class="d-inline-flex align-items-center"
                      onsubmit="return confirm('Delete image {{ img.title }}?');">
                  {{ form.csrf_token }}
                  <input type="hidden" name="action" value="delete_image">
                  <input type="hidden" name="image_id" value="{{ img.id }}">
                  <button class="btn btn-outline-danger btn-sm">Delete</button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="11" class="text-center text-muted py-4">No images</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% elif tab == 'users' %}
      <table class="table table-striped align-middle mt-3">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Images</th>
            <th>Role</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for v in users %}
          <tr>
            <td>{{ v.id }}</td>
            <td>{{ v.username }}</td>

            <td>
              {% if edit_user_id and (v.id|string) == (edit_user_id|string) %}
              <input type="email" class="form-control form-control-sm" name="email" form="user-form-{{ v.id }}"
                value="{{ v.email }}" required>
              {% else %}
              {{ v.email }}
              {% endif %}
            </td>

            <td>{{ v.image_count }}</td>

            <td>
              {% if edit_user_id and (v.id|string) == (edit_user_id|string) %}
              <select class="form-select form-select-sm" name="role" form="user-form-{{ v.id }}">
                {% for rname in ['admin','vendor','customer'] %}
                <option value="{{ rname }}" {{ 'selected' if v.role==rname else '' }}>{{ rname }}</option>
                {% endfor %}
              </select>
              {% else %}
              <span class="badge text-bg-secondary">{{ v.role }}</span>
              {% endif %}
            </td>

            <td class="text-nowrap">
              {% if edit_user_id and (v.id|string) == (edit_user_id|string) %}
              <form id="user-form-{{ v.id }}" method="post" class="d-inline">
                {{ form.csrf_token }}
                <input type="hidden" name="action" value="edit_user">
                <input type="hidden" name="user_id" value="{{ v.id }}">
                <button class="btn btn-dark btn-sm">Save</button>
              </form>
              <a class="btn btn-outline-secondary btn-sm"
                href="{{ url_for('main.vendor_management', tab='users') }}">Cancel</a>
              {% else %}
              <a class="btn btn-outline-secondary btn-sm"
                href="{{ url_for('main.vendor_management', tab='users', edit_user_id=v.id) }}">Edit</a>

              <form method="post" class="d-inline" onsubmit="return confirm('Delete vendor {{ v.username }}?');">
                {{ form.csrf_token }}
                <input type="hidden" name="action" value="delete_vendor">
                <input type="hidden" name="delete_vendor_id" value="{{ v.id }}">
                <button class="btn btn-outline-danger btn-sm">Delete</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">No users</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% elif tab == 'orders' %}
      <table class="table table-striped align-middle mt-3">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Total</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
          <tr>
            <td>{{ o.id }}</td>
            <td>{{ o.customer }}</td>
            <td><span class="badge text-bg-secondary">{{ o.status }}</span></td>
            <td>{{ '%.2f'|format(o.total_amount or 0) }}</td>
            <td>{{ o.created_at }}</td>
            <td>
              <form method="post" class="d-inline">
                {{ form.csrf_token }}
                <input type="hidden" name="action" value="update_order_status">
                <input type="hidden" name="order_id" value="{{ o.id }}">
                <select name="status" class="form-select form-select-sm d-inline-block" style="width:auto;">
                  {% for s in ['pending','paid','completed','cancelled'] %}
                  <option value="{{ s }}" {{ 'selected' if o.status==s else '' }}>{{ s }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-sm btn-outline-dark ms-1">Save</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">No orders</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% elif tab == 'events' %}
      <div class="row g-3 mt-3">
        <div class="col-md-5">
          <form method="post" class="card card-body">
            {{ form.csrf_token }}
            <input type="hidden" name="action" value="add_event">
            <label class="form-label">Add Event</label>
            <div class="input-group">
              <input type="text" class="form-control" name="name" placeholder="Event name" required>
              <button class="btn btn-dark">Add</button>
            </div>
          </form>
        </div>
        <div class="col-md-7">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Name</th><th class="text-end">Action</th></tr></thead>
            <tbody>
              {% for e in events %}
              <tr>
                <td>{{ e.id }}</td>
                <td>{{ e.name }}</td>
                <td class="text-end">
                  <form method="post" class="d-inline" onsubmit="return confirm('Delete event {{ e.name }}?')">
                    {{ form.csrf_token }}
                    <input type="hidden" name="action" value="delete_event">
                    <input type="hidden" name="id" value="{{ e.id }}">
                    <button class="btn btn-outline-danger btn-sm">Delete</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted">No events</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% elif tab == 'categories' %}
      <div class="row g-3 mt-3">
        <div class="col-md-5">
          <form method="post" class="card card-body">
            {{ form.csrf_token }}
            <input type="hidden" name="action" value="add_category">
            <label class="form-label">Add Category</label>
            <div class="input-group">
              <input type="text" class="form-control" name="name" placeholder="Category name" required>
              <button class="btn btn-dark">Add</button>
            </div>
          </form>
        </div>
        <div class="col-md-7">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Name</th><th class="text-end">Action</th></tr></thead>
            <tbody>
              {% for c in category_list %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.name }}</td>
                <td class="text-end">
                  <form method="post" class="d-inline" onsubmit="return confirm('Delete category {{ c.name }}?')">
                    {{ form.csrf_token }}
                    <input type="hidden" name="action" value="delete_category">
                    <input type="hidden" name="id" value="{{ c.id }}">
                    <button class="btn btn-outline-danger btn-sm">Delete</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted">No categories</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% elif tab == 'licenses' %}
      <div class="row g-3 mt-3">
        <div class="col-md-5">
          <form method="post" class="card card-body">
            {{ form.csrf_token }}
            <input type="hidden" name="action" value="add_license">
            <label class="form-label">Add License</label>
            <div class="input-group">
              <input type="text" class="form-control" name="type" placeholder="License type" required>
              <button class="btn btn-dark">Add</button>
            </div>
          </form>
        </div>
        <div class="col-md-7">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Type</th><th class="text-end">Action</th></tr></thead>
            <tbody>
              {% for l in licenses %}
              <tr>
                <td>{{ l.id }}</td>
                <td>{{ l.type }}</td>
                <td class="text-end">
                  <form method="post" class="d-inline" onsubmit="return confirm('Delete license {{ l.type }}?')">
                    {{ form.csrf_token }}
                    <input type="hidden" name="action" value="delete_license">
                    <input type="hidden" name="id" value="{{ l.id }}">
                    <button class="btn btn-outline-danger btn-sm">Delete</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted">No licenses</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      {% else %}
      <h3 class="mt-2">My Images</h3>

      <table class="table table-md align-middle">
        <thead class="table-light">
          <tr>
            <th>Item</th>
            <th>Resolution</th>
            <th class="text-center">Format</th>
            <th class="text-center">Event</th>
            <th class="text-center">Category</th>
            <th class="text-center">License</th>
            <th class="text-center">Price</th>
            <th class="text-center">Uploaded date</th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for img in images %}
          <tr>
            <td>
              <div class="d-flex align-items-center gap-1">
                <div class="flex-shrink-0" style="width:40px;height:30px">
                  <img src="{{ url_for('static', filename=img.url) }}" class="w-100 h-100 object-fit-contain d-block" alt="{{ img.title }}">
                </div>
                <p class="fw-semibold mb-0 ms-1 text-truncate">{{ img.title }}</p>
              </div>
            </td>

            <td><span class="badge text-bg-light">{{ img.resolution }}</span></td>
            <td class="text-uppercase text-center"><span class="badge text-bg-light">{{ img.format }}</span></td>

            <td class="text-center">
              <span class="badge badge-event">{{ img.event_name or '-' }}</span>
            </td>

            <td class="text-center">
              {% if img.category_names %}
                {% for category in img.category_names %}
                  <span class="badge badge-category">#{{ category }}</span>
                {% endfor %}
              {% else %}
                —
              {% endif %}
            </td>
            <td class="text-center">
              {% if img.license_types %}
                <span class="badge text-bg-dark">{{ img.license_types|join(', ') }}</span>
              {% else %}—{% endif %}
            </td>

            <td class="text-center">${{ '%.2f'|format(img.price or 0) }}</td>
            <td class="text-center small text-muted">{{ img.uploaded_at }}</td>

            <td>
              <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('vendor.edit', image_id=img.id) }}">
                Edit
              </a>
            </td>
            <td>
              <form method="POST" action="{{ url_for('vendor.delete', image_id=img.id) }}" onsubmit="return confirm('Delete this item?');" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="text-center text-muted py-5">You haven’t uploaded anything yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
  </div>
</main>
{% endblock %}