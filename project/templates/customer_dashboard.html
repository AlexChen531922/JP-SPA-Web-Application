{% extends "base.html" %}
{% block title %}會員中心 - 晶品芳療{% endblock %}

{% block content %}
<div class="container py-4">

  <h2 class="fw-bold mb-4"><i class="bi bi-person-circle"></i> 會員中心</h2>

  <div class="row g-4">

    <div class="col-md-3">
      <div class="list-group sticky-top" style="top: 100px;">
        <a href="{{ url_for('customer.dashboard') }}" class="list-group-item list-group-item-action active">
          <i class="bi bi-house-door"></i> 個人首頁
        </a>
        <a href="{{ url_for('customer.bookings') }}" class="list-group-item list-group-item-action">
          <i class="bi bi-calendar-check"></i> 我的預約
        </a>
        <a href="{{ url_for('customer.orders') }}" class="list-group-item list-group-item-action">
          <i class="bi bi-bag-check"></i> 我的訂單
        </a>
        <a href="#profileModal" data-bs-toggle="modal" class="list-group-item list-group-item-action">
          <i class="bi bi-person-gear"></i> 個人資料
        </a>
      </div>
    </div>

    <div class="col-md-9">

      <div class="card border-0 shadow-sm mb-4 bg-primary text-white"
        style="background: linear-gradient(45deg, #4B2E39, #B05E72);">
        <div class="card-body p-4">
          <h4 class="fw-bold">歡迎回來，{{ user.firstname }}！</h4>
          <p class="mb-0 opacity-75">這是您的會員專屬空間，您可以查看預約、訂單或修改個人資料。</p>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <h6 class="text-muted">有效課程</h6>
              <h3 class="fw-bold text-primary">{{ active_courses|length }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <h6 class="text-muted">最近訂單</h6>
              <h3 class="fw-bold text-success">{{ recent_orders|length }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <h6 class="text-muted">已購產品數</h6>
              <h3 class="fw-bold text-warning">{{ purchased_products|length }}</h3>
            </div>
          </div>
        </div>
      </div>

      <h5 class="fw-bold mb-3">進行中的課程</h5>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>課程名稱</th>
                  <th>購買/剩餘</th>
                  <th>狀態</th>
                  <th>購買日期</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for course in active_courses %}
                <tr>
                  <td class="fw-bold">{{ course.course_name }}</td>
                  <td>{{ course.sessions_purchased }} / <span class="text-success fw-bold">{{ course.sessions_remaining
                      }}</span></td>
                  <td>
                    {% if course.status == 'pending' %}<span class="badge bg-warning text-dark">待確認</span>
                    {% elif course.status == 'confirmed' %}<span class="badge bg-primary">已確認</span>
                    {% else %}<span class="badge bg-secondary">{{ course.status }}</span>
                    {% endif %}
                  </td>
                  <td class="text-muted">{{ course.created_at.strftime('%Y-%m-%d') }}</td>
                  <td class="text-end">
                    {% if course.status in ['pending', 'confirmed'] %}
                    <form action="{{ url_for('customer.cancel_booking', booking_id=course.id) }}" method="POST"
                      class="d-inline" onsubmit="return confirm('確定要取消此預約嗎？');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger">取消</button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center py-4 text-muted">目前沒有進行中的課程</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <h5 class="fw-bold mb-3">最近訂單</h5>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>訂單編號</th>
                  <th>金額</th>
                  <th>狀態</th>
                  <th>日期</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for order in recent_orders %}
                <tr>
                  <td>#{{ order.id }}</td>
                  <td class="fw-bold">NT$ {{ '{:,.0f}'.format(order.total_amount) }}</td>
                  <td>
                    {% if order.status == 'pending' %}<span class="badge bg-warning text-dark">待確認</span>
                    {% elif order.status == 'confirmed' %}<span class="badge bg-primary">已確認</span>
                    {% elif order.status == 'completed' %}<span class="badge bg-success">已完成</span>
                    {% elif order.status == 'cancelled' %}<span class="badge bg-secondary">已取消</span>
                    {% endif %}
                  </td>
                  <td class="text-muted small">{{ order.created_at.strftime('%Y-%m-%d') }}</td>
                  <td class="text-end">
                    <a href="{{ url_for('customer.order_detail', order_id=order.id) }}"
                      class="btn btn-sm btn-outline-primary">詳情</a>

                    {% if order.status in ['pending', 'confirmed'] %}
                    <form action="{{ url_for('customer.cancel_order', order_id=order.id) }}" method="POST"
                      class="d-inline" onsubmit="return confirm('確定要取消這筆訂單嗎？取消後將釋出庫存。');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger">取消</button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center py-4 text-muted">目前沒有訂單紀錄</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">編輯個人資料</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('customer.update_profile') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="row">
            <div class="col-6 mb-3">
              <label class="form-label">姓氏</label>
              <input type="text" name="surname" class="form-control" value="{{ user.surname }}" required>
            </div>
            <div class="col-6 mb-3">
              <label class="form-label">名字</label>
              <input type="text" name="firstname" class="form-control" value="{{ user.firstname }}" required>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">電話</label>
            <input type="tel" name="phone" class="form-control" value="{{ user.phone or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">LINE ID</label>
            <input type="text" name="line_id" class="form-control" value="{{ user.line_id or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">地址</label>
            <textarea name="address" class="form-control" rows="2">{{ user.address or '' }}</textarea>
          </div>
          <hr>
          <div class="mb-3">
            <label class="form-label">新密碼（不修改請留空）</label>
            <input type="password" name="password" class="form-control" placeholder="至少10碼，含大小寫字母、數字及符號"
              pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W]).{10,}" title="密碼需至少10碼，且包含大小寫字母、數字及特殊符號">
            <small class="text-muted d-block mt-1">規則：10字元以上，需含大寫、小寫、數字及符號</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">儲存變更</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}