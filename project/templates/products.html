{% extends "base.html" %}
{% block title %}產品介紹 - 晶品芳療{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="text-center mb-4">
    <p class="lead text-muted">選擇適合您的芳療產品，讓身心得到完整的放鬆與療癒</p>
  </div>

  <div class="row g-3 align-items-center mb-4">

    <div class="col-12 col-lg-auto me-auto">
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('main.products') }}"
          class="btn btn-sm {% if not current_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
          全部
        </a>
        {% for category in product_categories %}
        <a href="{{ url_for('main.products', category=category.id) }}"
          class="btn btn-sm {% if current_category == category.id %}btn-primary{% else %}btn-outline-primary{% endif %}">
          {{ category.name }}
        </a>
        {% endfor %}
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <form method="GET" action="{{ url_for('main.products') }}" class="input-group">
        <input type="search" name="q" class="form-control" placeholder="搜尋產品名稱..." value="{{ search_query or '' }}"
          aria-label="搜尋產品">

        <button class="btn btn-primary" type="submit">
          <i class="bi bi-search"></i>
        </button>

        {% if search_query %}
        <a href="{{ url_for('main.products') }}" class="btn btn-outline-secondary" title="清除搜尋">
          <i class="bi bi-x-lg"></i>
        </a>
        {% endif %}
      </form>
    </div>
  </div>

  <div id="product-list" class="row g-3 g-md-4">
    {% for product in products %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card h-100 shadow-sm border-0 hover-zoom"
        style="border-radius: 16px; overflow: hidden; transition: all 0.3s;">

        <div data-bs-toggle="modal" data-bs-target="#productModal{{ product.id }}" style="cursor:pointer;">

          <div class="ratio ratio-4x3 bg-light">
            {% if product.image %}
            <img src="{{ url_for('static', filename=product.image) }}" class="object-fit-cover" alt="{{ product.name }}"
              loading="lazy" onerror="this.src='{{ url_for('static', filename='img/default-product.png') }}'">
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
              <i class="bi bi-image fs-3 opacity-25"></i>
            </div>
            {% endif %}
          </div>

          <div class="card-body p-3 d-flex flex-column">
            <h6 class="card-title fw-bold text-dark mb-1 text-truncate">{{ product.name }}</h6>
            <div class="mb-2">
              {% if product.category_name %}
              <small class="text-success bg-success bg-opacity-10 px-2 py-1 rounded-pill">
                {{ product.category_name }}
              </small>
              {% endif %}
            </div>
            <div class="mt-auto d-flex align-items-center justify-content-between pt-2">
              <span class="fw-bold text-success">請洽詢</span>
              {% if (product.stock_quantity | default(0)) <= 0 %} <span class="badge bg-secondary"
                style="font-size: 0.7em;">補貨中</span>
                {% endif %}
            </div>
          </div>
        </div>

        <div class="card-footer bg-white border-0 p-3 pt-0">
          {% if session.get('user', {}).get('role') in ['customer', 'admin', 'staff'] %}
          <form action="{{ url_for('main.add_to_cart', product_id=product.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn btn-success w-100 rounded-pill btn-sm fw-bold py-2" {% if
              (product.stock_quantity | default(0)) <=0 %}disabled{% endif %}>
              {% if (product.stock_quantity | default(0)) > 0 %}
              <i class="bi bi-cart-plus"></i> 加入購物車
              {% else %}
              暫時缺貨
              {% endif %}
            </button>
          </form>
          {% else %}
          <button class="btn btn-outline-secondary w-100 rounded-pill btn-sm py-2" disabled>登入後購買</button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</div>

<div id="loading" class="text-center mt-4" style="display:none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">載入中...</span>
  </div>
  <p class="text-muted mt-2">載入更多產品...</p>
</div>

<div id="no-more" class="text-center text-muted mt-4" style="display:none;">
  <p>已顯示全部產品</p>
</div>

{% if products|length == 0 %}
<div class="text-center py-5">
  <i class="bi bi-inbox fs-1 text-muted"></i>
  <p class="text-muted mt-3">目前沒有產品</p>
  <a href="{{ url_for('main.products') }}" class="btn btn-primary">瀏覽全部產品</a>
</div>
{% endif %}

{% for product in products %}
<div class="modal fade" id="productModal{{ product.id }}" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow position-relative" style="border-radius: 24px; overflow: hidden;">

      <button type="button" class="btn-close position-absolute top-0 end-0 m-4" data-bs-dismiss="modal"
        aria-label="Close"
        style="z-index: 1080; background-color: rgba(255,255,255,0.8); border-radius: 50%; padding: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
      </button>

      <div class="modal-body p-0">
        <div class="row g-0">
          <div class="col-md-6">
            <div class="ratio ratio-1x1 bg-light h-100">
              {% if product.image %}
              <img src="{{ url_for('static', filename=product.image) }}" class="object-fit-cover"
                alt="{{ product.name }}">
              {% else %}
              <div class="d-flex align-items-center justify-content-center h-100"><i
                  class="bi bi-image fs-1 text-muted"></i></div>
              {% endif %}
            </div>
          </div>

          <div class="col-md-6 d-flex flex-column p-4 p-lg-5">
            <div>
              <span class="badge bg-success bg-opacity-10 text-success mb-2 rounded-pill px-3">{{ product.category_name
                }}</span>
              <h3 class="fw-bold mb-3">{{ product.name }}</h3>
              <p class="text-secondary lh-lg mb-4">{{ product.description }}</p>

              <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3">
                {% if (product.stock_quantity | default(0)) > 0 %}
                <i class="bi bi-check-circle-fill text-success fs-5 me-2"></i>
                <div>
                  <small class="text-muted d-block" style="font-size: 0.8rem;">庫存狀態</small>
                  <span class="text-success fw-bold">現貨供應 </span>
                </div>
                {% else %}
                <i class="bi bi-x-circle-fill text-danger fs-5 me-2"></i>
                <div>
                  <small class="text-muted d-block" style="font-size: 0.8rem;">庫存狀態</small>
                  <span class="text-danger fw-bold">目前缺貨</span>
                </div>
                {% endif %}
              </div>
            </div>

            <div class="mt-auto pt-3 border-top">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">售價</span>
                <span class="fs-4 fw-bold text-success">請洽詢</span>
              </div>

              <form action="{{ url_for('main.add_to_cart', product_id=product.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-success w-100 rounded-pill py-3 fw-bold shadow-sm hover-scale" {%
                  if (product.stock_quantity | default(0)) <=0 %}disabled{% endif %}>
                  {% if (product.stock_quantity | default(0)) > 0 %}
                  <i class="bi bi-cart-plus me-1"></i> 送出預訂
                  {% else %}
                  暫時缺貨
                  {% endif %}
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
  let page = 1;
  let loading = false;
  let hasMore = {{ 'true' if products| length >= 15 else 'false' }};
  const productList = document.getElementById('product-list');
  const loadingIndicator = document.getElementById('loading');
  const noMoreIndicator = document.getElementById('no-more');
  const currentCategory = {{ current_category| tojson }};
  const searchQuery = {{ search_query| tojson }};

  // Infinite scroll
  function loadMoreProducts() {
    if (loading || !hasMore) return;

    const scrollTop = window.scrollY;
    const windowHeight = window.innerHeight;
    const docHeight = document.documentElement.scrollHeight;

    if (scrollTop + windowHeight >= docHeight - 300) {
      loading = true;
      page += 1;
      loadingIndicator.style.display = 'block';

      let url = `/products?page=${page}`;
      if (currentCategory) url += `&category=${currentCategory}`;
      if (searchQuery) url += `&q=${encodeURIComponent(searchQuery)}`;

      fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(res => res.text())
        .then(html => {
          loadingIndicator.style.display = 'none';

          if (html.trim()) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const newItems = tempDiv.querySelectorAll('.col-6');

            if (newItems.length > 0) {
              newItems.forEach(item => {
                productList.appendChild(item);
              });
              loading = false;
            } else {
              hasMore = false;
              noMoreIndicator.style.display = 'block';
            }
          } else {
            hasMore = false;
            noMoreIndicator.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('載入失敗:', err);
          loadingIndicator.style.display = 'none';
          loading = false;
        });
    }
  }

  if (hasMore) {
    window.addEventListener('scroll', loadMoreProducts);
  }

  // Hover effect
  document.querySelectorAll('.hover-zoom').forEach(card => {
    card.addEventListener('mouseenter', function () { this.style.transform = 'translateY(-5px)'; });
    card.addEventListener('mouseleave', function () { this.style.transform = 'translateY(0)'; });
  });
</script>

<style>
  .hover-zoom {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .hover-zoom:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
  }

  .object-fit-cover {
    object-fit: cover;
  }
</style>
{% endblock %}