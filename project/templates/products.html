{% extends "base.html" %}
{% block title %}產品介紹 - 晶品芳療{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="text-center mb-4">
    <p class="lead text-muted">選擇適合您的芳療產品，讓身心得到完整的放鬆與療癒</p>
  </div>

  <div class="row g-3 align-items-center mb-4">

    <div class="col-12 col-lg-auto me-auto">
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('main.products') }}"
          class="btn btn-sm {% if not current_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
          全部
        </a>
        {% for category in product_categories %}
        <a href="{{ url_for('main.products', category=category.id) }}"
          class="btn btn-sm {% if current_category == category.id %}btn-primary{% else %}btn-outline-primary{% endif %}">
          {{ category.name }}
        </a>
        {% endfor %}
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <form method="GET" action="{{ url_for('main.products') }}" class="input-group">
        <input type="search" name="q" class="form-control" placeholder="搜尋產品名稱..." value="{{ search_query or '' }}"
          aria-label="搜尋產品">

        <button class="btn btn-primary" type="submit">
          <i class="bi bi-search"></i>
        </button>

        {% if search_query %}
        <a href="{{ url_for('main.products') }}" class="btn btn-outline-secondary" title="清除搜尋">
          <i class="bi bi-x-lg"></i>
        </a>
        {% endif %}
      </form>
    </div>
  </div>

  <div id="product-list" class="row g-3 g-md-4">
    {% for product in products %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card h-100 hover-zoom shadow-sm d-flex flex-column">

        <div data-bs-toggle="modal" data-bs-target="#productModal{{ product.id }}"
          class="d-flex flex-column flex-grow-1" style="cursor:pointer;">

          <div class="ratio ratio-1x1">
            {% if product.image %}
            <img src="{{ url_for('static', filename=product.image) }}" class="card-img-top object-fit-cover"
              alt="{{ product.name }}" loading="lazy"
              onerror="this.src='{{ url_for('static', filename='img/default-product.png') }}'">
            {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center">
              <i class="bi bi-image fs-1 text-muted opacity-25"></i>
            </div>
            {% endif %}
          </div>

          <div class="card-body d-flex flex-column flex-grow-1 p-3">
            <h6 class="card-title text-truncate fw-bold mb-1">{{ product.name }}</h6>

            <div class="mt-auto">
              <p class="mb-2 text-primary fw-bold small">
                請洽詢
              </p>

              {% if product.category_name %}
              <span class="badge bg-light text-dark fw-normal">{{ product.category_name }}</span>
              {% else %}
              <span class="badge" style="visibility: hidden;">&nbsp;</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card-footer bg-white border-0 pt-0 pb-3 px-3">
          {% if session.get('user', {}).get('role') in ['customer', 'admin', 'staff'] %}
          <form action="{{ url_for('main.add_to_cart', product_id=product.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn btn-primary btn-sm w-100" {% if product.stock_quantity <=0 %}disabled{%
              endif %}>
              {% if product.stock_quantity > 0 %}
              <i class="bi bi-cart-plus"></i> 加入購物車
              {% else %}
              <i class="bi bi-x-circle"></i> 暫時缺貨
              {% endif %}
            </button>
          </form>
          {% else %}
          <button class="btn btn-secondary btn-sm w-100" disabled>請先登入</button>
          {% endif %}
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  <div id="loading" class="text-center mt-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
    <p class="text-muted mt-2">載入更多產品...</p>
  </div>

  <div id="no-more" class="text-center text-muted mt-4" style="display:none;">
    <p>已顯示全部產品</p>
  </div>

  {% if products|length == 0 %}
  <div class="text-center py-5">
    <i class="bi bi-inbox fs-1 text-muted"></i>
    <p class="text-muted mt-3">目前沒有產品</p>
    <a href="{{ url_for('main.products') }}" class="btn btn-primary">瀏覽全部產品</a>
  </div>
  {% endif %}

  {% for product in products %}
  <div class="modal fade" id="productModal{{ product.id }}" tabindex="-1"
    aria-labelledby="productModalLabel{{ product.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content overflow-hidden border-0">
        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="ratio ratio-1x1 rounded-3 overflow-hidden shadow-sm">
                {% if product.image %}
                <img src="{{ url_for('static', filename=product.image) }}" class="object-fit-cover"
                  alt="{{ product.name }}">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center h-100">
                  <i class="bi bi-image display-1 text-muted opacity-25"></i>
                </div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-6 d-flex flex-column">
              <div class="mb-auto">
                <span class="badge bg-primary bg-opacity-10 text-primary mb-2">{{ product.category_name
                  }}</span>
                <h3 class="fw-bold mb-3">{{ product.name }}</h3>
                <p class="text-secondary lh-lg mb-4" style="white-space: pre-line;">{{
                  product.description }}</p>

                <div class="alert alert-light border-start border-4 border-primary">
                  <p class="mb-0 small text-muted">庫存狀態：
                    {% if product.stock_quantity > 0 %}
                    <span class="text-success fw-bold">現貨供應</span>
                    {% else %}
                    <span class="text-danger fw-bold">補貨中</span>
                    {% endif %}
                  </p>
                </div>
              </div>

              <div class="mt-4 pt-3 border-top">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <span class="text-muted small">售價</span>
                  <span class="fs-4 fw-bold text-primary">請洽詢</span>
                </div>

                <form action="{{ url_for('main.add_to_cart', product_id=product.id) }}" method="POST"
                  class="d-grid gap-2">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-primary btn-lg" {% if product.stock_quantity<=0 %}disabled{%
                    endif %}>
                    {% if product.stock_quantity > 0 %}
                    <i class="bi bi-cart-plus"></i> 加入購物車
                    {% else %}
                    <i class="bi bi-x-circle"></i> 暫時缺貨
                    {% endif %}
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

</div>
{% endblock %}

{% block scripts %}
<script>
  let page = 1;
  let loading = false;
  let hasMore = {{ 'true' if products| length >= 15 else 'false' }};
  const productList = document.getElementById('product-list');
  const loadingIndicator = document.getElementById('loading');
  const noMoreIndicator = document.getElementById('no-more');
  const currentCategory = {{ current_category| tojson }};
  const searchQuery = {{ search_query| tojson }};

  // Infinite scroll
  function loadMoreProducts() {
    if (loading || !hasMore) return;

    const scrollTop = window.scrollY;
    const windowHeight = window.innerHeight;
    const docHeight = document.documentElement.scrollHeight;

    if (scrollTop + windowHeight >= docHeight - 300) {
      loading = true;
      page += 1;
      loadingIndicator.style.display = 'block';

      let url = `/products?page=${page}`;
      if (currentCategory) url += `&category=${currentCategory}`;
      if (searchQuery) url += `&q=${encodeURIComponent(searchQuery)}`;

      fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(res => res.text())
        .then(html => {
          loadingIndicator.style.display = 'none';

          if (html.trim()) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const newItems = tempDiv.querySelectorAll('.col-6'); // 確保抓取正確的 class

            if (newItems.length > 0) {
              newItems.forEach(item => {
                productList.appendChild(item);
              });
              loading = false;
            } else {
              hasMore = false;
              noMoreIndicator.style.display = 'block';
            }
          } else {
            hasMore = false;
            noMoreIndicator.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('載入失敗:', err);
          loadingIndicator.style.display = 'none';
          loading = false;
        });
    }
  }

  if (hasMore) {
    window.addEventListener('scroll', loadMoreProducts);
  }

  // Hover effect
  document.querySelectorAll('.hover-zoom').forEach(card => {
    card.addEventListener('mouseenter', function () { this.style.transform = 'translateY(-5px)'; });
    card.addEventListener('mouseleave', function () { this.style.transform = 'translateY(0)'; });
  });
</script>

<style>
  .hover-zoom {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .hover-zoom:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
  }

  .object-fit-cover {
    object-fit: cover;
  }
</style>
{% endblock %}