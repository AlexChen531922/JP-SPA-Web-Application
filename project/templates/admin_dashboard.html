{% extends "base.html" %}
{% block title %}管理後台 - 晶品芳療{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">
      <i class="bi bi-speedometer2"></i> 管理後台
    </h2>
    <div class="text-muted">
      歡迎回來，{{ session.get('user', {}).get('firstname') }}
      <span class="badge bg-secondary">{{ session.get('user', {}).get('role') }}</span>
    </div>
  </div>

  <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link {% if not tab or tab == 'overview' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#overview">
        <i class="bi bi-grid"></i> 總覽
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'products' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#products">
        <i class="bi bi-box"></i> 產品管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'courses' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#courses">
        <i class="bi bi-calendar-check"></i> 課程管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'posts' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#posts">
        <i class="bi bi-newspaper"></i> 文章管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'orders' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#orders">
        <i class="bi bi-cart"></i> 訂單管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'bookings' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#bookings">
        <i class="bi bi-calendar2-week"></i> 預約管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'customers' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#customers">
        <i class="bi bi-people"></i> 客戶管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'categories' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#categories">
        <i class="bi bi-tags"></i> 分類管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'events' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#events">
        <i class="bi bi-calendar-event"></i> 活動管理
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if tab == 'inventory' %}active{% endif %}" data-bs-toggle="tab"
        data-bs-target="#inventory">
        <i class="bi bi-boxes"></i> 庫存管理
      </button>
    </li>
    {% if session.get('user', {}).get('role') == 'admin' %}
    <li class="nav-item">
      <button class="nav-link {% if tab == 'logs' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#logs">
        <i class="bi bi-clock-history"></i> 操作紀錄
      </button>
    </li>
    {% endif %}
  </ul>

  <div class="tab-content">

    <div class="tab-pane fade {% if not tab or tab == 'overview' %}show active{% endif %}" id="overview">

      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">訂單總數</h6>
                  <h3 class="fw-bold mb-0">{{ stats.orders }}</h3>
                </div>
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                  <i class="bi bi-cart-check fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">預約總數</h6>
                  <h3 class="fw-bold mb-0">{{ stats.bookings }}</h3>
                </div>
                <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                  <i class="bi bi-calendar-check fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">產品品項</h6>
                  <h3 class="fw-bold mb-0">{{ stats.products }}</h3>
                </div>
                <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                  <i class="bi bi-box fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">課程項目</h6>
                  <h3 class="fw-bold mb-0">{{ stats.courses }}</h3>
                </div>
                <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info">
                  <i class="bi bi-journal-text fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">客戶總數</h6>
                  <h3 class="fw-bold mb-0">{{ stats.customers }}</h3>
                </div>
                <div class="bg-secondary bg-opacity-10 p-3 rounded-circle text-secondary">
                  <i class="bi bi-people fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">發布文章</h6>
                  <h3 class="fw-bold mb-0">{{ stats.posts }}</h3>
                </div>
                <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger">
                  <i class="bi bi-newspaper fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">總營收</h6>
                  <h3 class="fw-bold mb-0 text-primary">NT$ {{ '{:,.0f}'.format(stats.revenue) }}</h3>
                </div>
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                  <i class="bi bi-currency-dollar fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% if session.get('user', {}).get('role') == 'admin' %}
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">淨利潤</h6>
                  <h3 class="fw-bold mb-0 text-success">NT$ {{ '{:,.0f}'.format(stats.net_profit) }}</h3>
                </div>
                <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                  <i class="bi bi-graph-up-arrow fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100 bg-light">
            <div class="card-body d-flex align-items-center justify-content-center text-muted">
              <small><i class="bi bi-lock-fill me-1"></i> 權限受限</small>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <button type="button" class="btn btn-outline-primary w-100 py-3" data-bs-toggle="modal"
            data-bs-target="#addProductModal">
            <i class="bi bi-plus-circle me-2"></i> 新增產品
          </button>
        </div>
        <div class="col-md-3">
          <button type="button" class="btn btn-outline-success w-100 py-3" data-bs-toggle="modal"
            data-bs-target="#addCourseModal">
            <i class="bi bi-plus-circle me-2"></i> 新增課程
          </button>
        </div>
        <div class="col-md-3">
          <a href="{{ url_for('admin.add_post') }}" class="btn btn-outline-info w-100 py-3">
            <i class="bi bi-plus-circle me-2"></i> 撰寫文章
          </a>
        </div>
        {% if session.get('user', {}).get('role') == 'admin' %}
        <div class="col-md-3">
          <a href="{{ url_for('reports.dashboard') }}" class="btn btn-outline-warning w-100 py-3">
            <i class="bi bi-graph-up me-2"></i> 查看報表
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'products' %}show active{% endif %}" id="products">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0"><i class="bi bi-box"></i> 產品管理</h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
          <i class="bi bi-plus-circle"></i> 新增產品
        </button>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">圖片</th>
                  <th>產品名稱</th>
                  <th>分類</th>
                  {% if session.get('user', {}).get('role') == 'admin' %}<th>成本</th>{% endif %}
                  <th>價格</th>
                  <th>庫存</th>
                  <th>狀態</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr>
                  <td><img src="{{ url_for('static', filename=product.image or 'img/placeholder.jpg') }}" width="50"
                      class="rounded"></td>
                  <td>{{ product.name }}</td>
                  <td><span class="badge bg-light text-dark">{{ product.category_name or '未分類' }}</span></td>
                  {% if session.get('user', {}).get('role') == 'admin' %}<td>{{ '{:,.0f}'.format(product.cost) }}</td>{%
                  endif %}
                  <td>{{ '{:,.0f}'.format(product.price) }}</td>
                  <td>{{ product.stock_quantity }}</td>
                  <td>
                    <span class="badge {% if product.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                      {{ '啟用' if product.is_active else '停用' }}
                    </span>
                  </td>
                  <td class="text-end">
                    {% set safe_product_data = {
                    'id': product.id,
                    'name': product.name,
                    'category_id': product.category_id,
                    'price': product.price,
                    'cost': product.cost,
                    'stock_quantity': product.stock_quantity,
                    'unit': product.unit,
                    'description': product.description,
                    'image': product.image,
                    'is_active': product.is_active
                    } %}

                    <button type="button" class="btn btn-sm btn-outline-primary" title="編輯"
                      onclick="fetchProductData({{ product.id }})">
                      <i class="bi bi-pencil"></i>
                    </button>

                    {% if session.get('user', {}).get('role') == 'admin' %}
                    <form method="POST" action="{{ url_for('admin.delete_product_modal', product_id=product.id) }}"
                      class="d-inline" onsubmit="return confirm('確定要刪除「{{ product.name }}」？');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="刪除">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'courses' %}show active{% endif %}" id="courses">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0"><i class="bi bi-calendar-check"></i> 課程管理</h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
          <i class="bi bi-plus-circle"></i> 新增課程
        </button>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">圖片</th>
                  <th>課程名稱</th>
                  <th>分類</th>
                  <th>價格</th>
                  <th>時長</th>
                  <th>狀態</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for course in courses %}
                <tr>
                  <td><img src="{{ url_for('static', filename=course.image or 'img/placeholder.jpg') }}" width="50"
                      class="rounded"></td>
                  <td>{{ course.name }}</td>
                  <td><span class="badge bg-light text-dark">{{ course.category_name }}</span></td>
                  <td>{{ '{:,.0f}'.format(course.regular_price) }}</td>
                  <td>{{ course.duration }} 分</td>
                  <td>
                    <span class="badge {% if course.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                      {{ '啟用' if course.is_active else '停用' }}
                    </span>
                  </td>
                  <td class="text-end">
                    {% set safe_course_data = {
                    'id': course.id,
                    'name': course.name,
                    'category_id': course.category_id,
                    'regular_price': course.regular_price,
                    'experience_price': course.experience_price,
                    'service_fee': course.service_fee,
                    'product_fee': course.product_fee,
                    'duration': course.duration,
                    'sessions': course.sessions,
                    'description': course.description,
                    'image': course.image,
                    'is_active': course.is_active
                    } %}
                    <button type="button" class="btn btn-sm btn-outline-primary" title="編輯"
                      onclick="fetchCourseData({{ course.id }})">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning"
                      onclick="openCapacityModal({{ course.id }}, '{{ course.name }}')">
                      <i class="bi bi-people"></i>
                    </button>
                    {% if session.get('user', {}).get('role') == 'admin' %}
                    <form method="POST" action="{{ url_for('admin.delete_course_modal', course_id=course.id) }}"
                      class="d-inline" onsubmit="return confirm('確定要刪除？');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'posts' %}show active{% endif %}" id="posts">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0"><i class="bi bi-newspaper"></i> 文章管理</h4>
        <a href="{{ url_for('admin.add_post') }}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> 撰寫文章
        </a>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>標題</th>
                <th>狀態</th>
                <th>作者</th>
                <th>日期</th>
                <th class="text-end">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for post in posts %}
              <tr>
                <td>{{ post.title }}</td>
                <td><span class="badge bg-secondary">{{ post.status }}</span></td>
                <td>{{ post.author_name }}</td>
                <td>{{ post.published_at }}</td>
                <td class="text-end">
                  <a href="{{ url_for('admin.edit_post', post_id=post.id) }}" class="btn btn-sm btn-outline-primary"><i
                      class="bi bi-pencil"></i></a>
                  {% if session.get('user', {}).get('role') == 'admin' %}
                  <form method="POST" action="{{ url_for('admin.delete_post', post_id=post.id) }}" class="d-inline"
                    onsubmit="return confirm('確認刪除？')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'orders' %}show active{% endif %}" id="orders">
      <h4 class="fw-bold mb-3"><i class="bi bi-cart"></i> 訂單管理</h4>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
        <i class="bi bi-plus-circle"></i> 建立/補登訂單
      </button>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>客戶</th>
                <th>金額</th>
                <th>狀態</th>
                <th>日期</th>
                <th class="text-end">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for order in orders %}
              <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.firstname }} {{ order.surname }}</td>
                <td>NT$ {{ '{:,.0f}'.format(order.total_amount) }}</td>
                <td>
                  <form method="POST" action="{{ url_for('admin.update_order_status', order_id=order.id) }}"
                    class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="status" class="form-select form-select-sm d-inline-block w-auto"
                      onchange="this.form.submit()">
                      <option value="pending" {% if order.status=='pending' %}selected{% endif %}>待確認</option>
                      <option value="confirmed" {% if order.status=='confirmed' %}selected{% endif %}>已確認</option>
                      <option value="completed" {% if order.status=='completed' %}selected{% endif %}>已完成</option>
                      <option value="cancelled" {% if order.status=='cancelled' %}selected{% endif %}>已取消</option>
                    </select>
                  </form>
                </td>
                <td>{{ order.created_at.strftime('%Y-%m-%d') }}</td>
                <td class="text-end">
                  {% set items = order_items_map.get(order.id, []) %}
                  {% set safe_order_data = {
                  'id': order.id,
                  'customer_name': order.firstname ~ ' ' ~ order.surname,
                  'email': order.email,
                  'phone': order.phone,
                  'total_amount': order.total_amount,
                  'status': order.status,
                  'created_at': order.created_at.strftime('%Y-%m-%d %H:%M'),
                  'items': items
                  } %}
                  <button type="button" class="btn btn-sm btn-outline-info"
                    onclick="openOrderDetailModal({{ safe_order_data | tojson | forceescape }})">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'bookings' %}show active{% endif %}" id="bookings">
      <h4 class="fw-bold mb-3"><i class="bi bi-calendar2-week"></i> 預約管理</h4>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookingModal">
        <i class="bi bi-plus-circle"></i> 建立/補登預約
      </button>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>客戶</th>
                <th>課程</th>
                <th>時段</th>
                <th>狀態</th>
                <th class="text-end">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for booking in bookings %}
              <tr>
                <td>{{ booking.id }}</td>
                <td>{{ booking.firstname }} {{ booking.surname }}</td>
                <td>{{ booking.course_name }}</td>
                <td>
                  {% if booking.start_time %}
                  {{ booking.start_time.strftime('%Y-%m-%d %H:%M') }}
                  {% else %}無{% endif %}
                </td>
                <td>
                  <form method="POST" action="{{ url_for('admin.update_booking_status', booking_id=booking.id) }}"
                    class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="status" class="form-select form-select-sm d-inline-block w-auto"
                      onchange="this.form.submit()">
                      <option value="pending" {% if booking.status=='pending' %}selected{% endif %}>待確認</option>
                      <option value="confirmed" {% if booking.status=='confirmed' %}selected{% endif %}>已確認</option>
                      <option value="completed" {% if booking.status=='completed' %}selected{% endif %}>已完成</option>
                      <option value="cancelled" {% if booking.status=='cancelled' %}selected{% endif %}>已取消</option>
                    </select>
                  </form>
                </td>
                <td class="text-end">
                  {% set safe_booking_data = {
                  'id': booking.id,
                  'customer_name': booking.firstname ~ ' ' ~ booking.surname,
                  'phone': booking.phone,
                  'email': booking.email,
                  'line_id': booking.line_id,
                  'course_name': booking.course_name,
                  'time_str': booking.start_time.strftime('%Y-%m-%d %H:%M') if booking.start_time else '無',
                  'duration': booking.duration,
                  'sessions_purchased': booking.sessions_purchased,
                  'sessions_remaining': booking.sessions_remaining,
                  'total_amount': booking.total_amount,
                  'is_first_time': booking.is_first_time
                  } %}
                  <button type="button" class="btn btn-sm btn-outline-info"
                    onclick="openBookingDetailModal({{ safe_booking_data | tojson | forceescape }})">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'customers' %}show active{% endif %}" id="customers">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0"><i class="bi bi-people"></i> 客戶管理</h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
          <i class="bi bi-person-plus"></i> 新增客戶
        </button>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" style="min-width: 1000px;">
              <thead class="table-light">
                <tr>
                  <th>姓名</th>
                  <th>性別/年齡</th>
                  <th>LINE ID</th>
                  <th>電話</th>
                  <th>職業</th>
                  <th>備註</th>
                  <th>消費次數</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for customer in customers_list %}
                <tr>
                  <td>
                    <div class="fw-bold">{{ customer.surname }}{{ customer.firstname }}</div>
                    <small class="text-muted" style="font-size:0.8em;">{{ customer.username }}</small>
                  </td>
                  <td>
                    {% if customer.gender == 'female' %}<i class="bi bi-gender-female text-danger"></i>
                    {% elif customer.gender == 'male' %}<i class="bi bi-gender-male text-primary"></i>
                    {% else %}<i class="bi bi-gender-ambiguous"></i>{% endif %}
                    {{ customer.age }}歲
                  </td>
                  <td>
                    {% if customer.line_id %}
                    <span class="text-success"><i class="bi bi-line"></i> {{ customer.line_id }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if customer.phone %}
                    {{ customer.phone }}
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td><small>{{ customer.occupation or '-' }}</small></td>
                  <td>
                    <small class="text-muted text-truncate d-inline-block" style="max-width: 150px;"
                      title="{{ customer.notes }}">
                      {{ customer.notes or '' }}
                    </small>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ customer.order_count }}訂</span>
                    <span class="badge bg-success">{{ customer.booking_count }}約</span>
                  </td>
                  <td class="text-end">
                    {% set safe_customer_data = {
                    'id': customer.id,
                    'firstname': customer.firstname,
                    'surname': customer.surname,
                    'email': customer.email,
                    'phone': customer.phone,
                    'line_id': customer.line_id,
                    'gender': customer.gender,
                    'birth_date': customer.birth_date | string,
                    'occupation': customer.occupation,
                    'address': customer.address,
                    'source_id': customer.source_id,
                    'notes': customer.notes
                    } %}
                    <button type="button" class="btn btn-sm btn-outline-primary"
                      onclick="openEditCustomerModal({{ safe_customer_data | tojson | forceescape }})">
                      <i class="bi bi-pencil"></i> 檢視
                    </button>

                    {% if session.get('user', {}).get('role') == 'admin' %}
                    <form method="POST" action="{{ url_for('admin.delete_customer', customer_id=customer.id) }}"
                      class="d-inline" onsubmit="return confirm('確定要刪除？');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                    </form>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'categories' %}show active{% endif %}" id="categories">
      <h4 class="fw-bold mb-4"><i class="bi bi-tags"></i> 分類管理</h4>
      <div class="row">
        <div class="col-md-6">
          <h5>產品分類</h5>
          <form method="POST" action="{{ url_for('admin.add_product_category') }}" class="input-group mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input name="name" class="form-control" placeholder="新增分類..." required>
            <button class="btn btn-primary">新增</button>
          </form>
          <ul class="list-group">
            {% for cat in product_categories %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ cat.name }}
              {% if session.get('user', {}).get('role') == 'admin' %}
              <form method="POST" action="{{ url_for('admin.delete_product_category', category_id=cat.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
              </form>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
        <div class="col-md-6">
          <h5>課程分類</h5>
          <form method="POST" action="{{ url_for('admin.add_course_category') }}" class="input-group mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input name="name" class="form-control" placeholder="新增分類..." required>
            <button class="btn btn-success">新增</button>
          </form>
          <ul class="list-group">
            {% for cat in course_categories %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ cat.name }}
              {% if session.get('user', {}).get('role') == 'admin' %}
              <form method="POST" action="{{ url_for('admin.delete_course_category', category_id=cat.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
              </form>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="tab-pane fade {% if tab == 'events' %}show active{% endif %}" id="events">
      <div class="d-flex justify-content-between mb-3">
        <h4>活動管理</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">新增活動</button>
      </div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>標題</th>
            <th>時間</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for event in events %}
          <tr>
            <td>{{ event.title }}</td>
            <td>{{ event.start_date }}</td>
            <td>
              {% set safe_event = {'id': event.id, 'title': event.title, 'description': event.description,
              'customer_id': event.customer_id, 'start_date': event.start_date|string, 'end_date':
              event.end_date|string,
              'duration': event.duration} %}
              <button class="btn btn-sm btn-outline-primary"
                onclick="openEditEventModal({{ safe_event | tojson | forceescape }})"><i
                  class="bi bi-pencil"></i></button>
              {% if session.get('user', {}).get('role') == 'admin' %}
              <form method="POST" action="{{ url_for('admin.delete_event', event_id=event.id) }}" class="d-inline"
                onsubmit="return confirm('刪除？')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="tab-pane fade {% if tab == 'inventory' %}show active{% endif %}" id="inventory">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0"><i class="bi bi-boxes"></i> 庫存管理</h4>
        <div>
          <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="bi bi-plus-lg"></i> 建立新產品
          </button>
          <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#restockModal">
            <i class="bi bi-box-arrow-in-down"></i> 進貨入庫
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
            data-bs-target="#adjustInventoryModal">
            <i class="bi bi-pencil-square"></i> 盤點調整
          </button>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle text-nowrap">
              <thead class="table-light">
                <tr>
                  <th style="width: 60px;">圖片</th>
                  <th>產品名稱</th>
                  <th>類別</th> {% if session.get('user', {}).get('role') == 'admin' %}
                  <th class="text-danger">成本價</th>
                  {% endif %}

                  <th>售價</th>
                  <th>庫存</th>

                  <th>描述</th>
                  <th>最後進貨</th>
                  <th>最後銷售</th>
                  <th class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                {% for prod in inventory_products %}
                <tr>
                  <td>
                    {% if prod.image %}
                    <img src="{{ url_for('static', filename='img/' + prod.image) }}" alt="Product" class="rounded"
                      style="width: 40px; height: 40px; object-fit: cover;">
                    {% else %}
                    <div class="bg-light rounded d-flex align-items-center justify-content-center text-muted"
                      style="width: 40px; height: 40px;">
                      <i class="bi bi-image"></i>
                    </div>
                    {% endif %}
                  </td>

                  <td class="fw-bold">{{ prod.name }}</td>

                  <td>
                    {% if prod.category_name %}
                    <span class="badge bg-secondary bg-opacity-10 text-dark border">
                      {{ prod.category_name }}
                    </span>
                    {% else %}
                    <span class="text-muted small">-</span>
                    {% endif %}
                  </td>

                  {% if session.get('user', {}).get('role') == 'admin' %}
                  <td class="text-danger">NT$ {{ '{:,.0f}'.format(prod.cost or 0) }}</td>
                  {% endif %}

                  <td>NT$ {{ '{:,.0f}'.format(prod.price) }} / {{ prod.unit or '件' }}</td>

                  <td>
                    {% if prod.stock_quantity <= 0 %} <span class="badge bg-danger">缺貨</span>
                      {% elif prod.stock_quantity < 10 %} <span class="badge bg-warning text-dark">{{
                        prod.stock_quantity }} (緊張)</span>
                        {% else %}
                        <span class="badge bg-success">{{ prod.stock_quantity }}</span>
                        {% endif %}
                  </td>

                  <td>
                    <small class="text-muted d-inline-block text-truncate" style="max-width: 150px;"
                      title="{{ prod.description }}">
                      {{ prod.description or '-' }}
                    </small>
                  </td>

                  <td class="small text-muted">{{ prod.last_purchase_date.strftime('%Y-%m-%d') if
                    prod.last_purchase_date else '-' }}</td>
                  <td class="small text-muted">{{ prod.last_sale_date.strftime('%Y-%m-%d') if prod.last_sale_date else
                    '-' }}</td>

                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="openRestockModal({{ prod.id }})">
                      <i class="bi bi-plus-lg"></i> 進貨
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    {% if session.get('user', {}).get('role') == 'admin' %}
    <div class="tab-pane fade {% if tab == 'logs' %}show active{% endif %}" id="logs">
      <h4 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> 操作紀錄</h4>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>時間</th>
                <th>操作者</th>
                <th>動作</th>
                <th>目標</th>
                <th>詳情</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody>
              {% for log in audit_logs %}
              <tr>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ log.operator_name }}</td>
                <td><span class="badge bg-secondary">{{ log.action }}</span></td>
                <td>{{ log.target_type }} #{{ log.target_id }}</td>
                <td><small class="text-muted">{{ log.details }}</small></td>
                <td>{{ log.ip_address }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" class="text-center p-4">無紀錄</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('admin.add_product_modal') }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">新增產品</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8"><label>名稱</label><input name="name" class="form-control" required></div>
            <div class="col-md-4"><label>分類</label>
              <select name="category_id" class="form-select">
                <option value="">未分類</option>{% for c in product_categories %}<option value="{{ c.id }}">{{ c.name }}
                </option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4"><label>價格</label><input name="price" type="number" class="form-control"></div>
            <div class="col-md-4"><label>成本</label><input name="cost" type="number" class="form-control"></div>
            <div class="col-md-4"><label>庫存</label><input name="stock" type="number" class="form-control"></div>
            <div class="col-12"><label>描述</label><textarea name="description" class="form-control"></textarea></div>
            <div class="col-12"><label>圖片</label><input type="file" name="image" class="form-control"></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">新增</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editProductForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="current_image" id="edit_product_current_image">
        <div class="modal-header">
          <h5 class="modal-title">編輯產品</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8"><label>名稱</label><input name="name" id="edit_product_name" class="form-control"
                required></div>
            <div class="col-md-4"><label>分類</label>
              <select name="category_id" id="edit_product_category" class="form-select">
                <option value="">未分類</option>{% for c in product_categories %}<option value="{{ c.id }}">{{ c.name }}
                </option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4"><label>價格</label><input name="price" id="edit_product_price" type="number"
                class="form-control"></div>
            {% if session.get('user', {}).get('role') == 'admin' %}
            <div class="col-md-4">
              <label class="form-label text-danger">成本 (Admin)</label>
              <input name="cost" id="edit_product_cost" type="number" class="form-control">
            </div>
            {% endif %}
            <div class="col-md-4"><label>庫存</label><input name="stock" id="edit_product_stock" type="number"
                class="form-control"></div>
            <div class="col-12"><label>描述</label><textarea name="description" id="edit_product_description"
                class="form-control"></textarea></div>
            <div class="col-6"><label>圖片</label><input type="file" name="image" class="form-control"></div>
            <div class="col-6"><img id="editProductPreview" width="100"></div>
            <div class="col-12"><input type="checkbox" name="is_active" id="edit_product_is_active"> 啟用</div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">更新</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addCourseModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('admin.add_course_modal') }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">新增課程</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8"><label>名稱</label><input name="name" class="form-control" required></div>
            <div class="col-md-4"><label>分類</label>
              <select name="category_id" class="form-select">
                <option value="">無</option>{% for c in course_categories %}<option value="{{ c.id }}">{{ c.name }}
                </option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4"><label>價格</label><input name="regular_price" type="number" class="form-control"></div>
            <div class="col-md-4"><label>體驗價</label><input name="experience_price" type="number" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label text-danger">服務成本</label>
              <input name="service_fee" type="number" step="1" class="form-control" value="0">
            </div>
            {% if session.get('user', {}).get('role') == 'admin' %}
            <div class="col-md-4">
              <label class="form-label text-danger">產品成本 (Admin)</label>
              <input name="product_fee" type="number" step="1" class="form-control" value="0">
            </div>
            {% endif %}
            <div class="col-md-4"><label>時長(分)</label><input name="duration" type="number" class="form-control"></div>
            <div class="col-12"><label>描述</label><textarea name="description" class="form-control"></textarea></div>
            <div class="col-12"><input type="file" name="image" class="form-control"></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">新增</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editCourseModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editCourseForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="current_image" id="edit_course_current_image">
        <div class="modal-header">
          <h5 class="modal-title">編輯課程</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-8"><label>名稱</label><input name="name" id="edit_course_name" class="form-control"
                required></div>
            <div class="col-md-4"><label>分類</label>
              <select name="category_id" id="edit_course_category" class="form-select">
                <option value="">無</option>{% for c in course_categories %}<option value="{{ c.id }}">{{ c.name }}
                </option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4"><label>價格</label><input name="regular_price" id="edit_course_regular_price"
                type="number" class="form-control"></div>
            <div class="col-md-4"><label>體驗價</label><input name="experience_price" id="edit_course_experience_price"
                type="number" class="form-control"></div>
            <div class="col-md-4"><label>時長</label><input name="duration" id="edit_course_duration" type="number"
                class="form-control"></div>
            <div class="col-md-4">
              <label class="form-label text-danger">服務成本</label>
              <input name="service_fee" id="edit_course_service_fee" type="number" step="0.01" class="form-control">
            </div>

            {% if session.get('user', {}).get('role') == 'admin' %}
            <div class="col-md-4">
              <label class="form-label text-danger">產品成本</label>
              <input name="product_fee" id="edit_course_product_fee" type="number" step="0.01" class="form-control">
            </div>
            {% endif %}
            <div class="col-12"><label>描述</label><textarea name="description" id="edit_course_description"
                class="form-control"></textarea></div>
            <div class="col-6"><input type="file" name="image" class="form-control"></div>
            <div class="col-6"><img id="editCoursePreview" width="100"></div>
            <div class="col-12"><input type="checkbox" name="is_active" id="edit_course_is_active"> 啟用</div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">更新</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="capacityModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">管理時段人數：<span id="cap_course_name" class="fw-bold text-primary"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div class="alert alert-light border-bottom mb-0 rounded-0">
          <i class="bi bi-info-circle"></i> 僅顯示未來 30 天內的時段。修改後點擊「儲存」即可生效。
        </div>

        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-hover table-striped mb-0 align-middle">
            <thead class="table-light sticky-top">
              <tr>
                <th class="ps-4">日期</th>
                <th>時段</th>
                <th class="text-center">目前預約</th>
                <th style="width: 150px;">人數上限</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="scheduleListBody">
              <tr>
                <td colspan="5" class="text-center py-4">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="orderDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">訂單詳情 #<span id="order_detail_id"></span></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>客戶:</strong> <span id="order_detail_customer"></span></p>
        <p><strong>Email:</strong> <span id="order_detail_email"></span></p>
        <p><strong>電話:</strong> <span id="order_detail_phone"></span></p>
        <hr>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>品項</th>
              <th>單價</th>
              <th>數量</th>
              <th>小計</th>
            </tr>
          </thead>
          <tbody id="order_detail_items"></tbody>
        </table>
        <h5 class="text-end">總金額: <span id="order_detail_total"></span></h5>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="bookingDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">預約詳情 #<span id="detail_id"></span></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>客戶:</strong> <span id="detail_customer"></span></p>
        <p><strong>電話:</strong> <span id="detail_phone"></span></p>
        <p><strong>Email:</strong> <span id="detail_email"></span></p>
        <hr>
        <p><strong>課程:</strong> <span id="detail_course"></span></p>
        <p><strong>時段:</strong> <span id="detail_time"></span></p>
        <p><strong>時長:</strong> <span id="detail_duration"></span> 分</p>
        <p><strong>堂數:</strong> <span id="detail_sessions"></span> (剩 <span id="detail_remaining"></span>)</p>
        <p><strong>金額:</strong> <span id="detail_amount"></span></p>
        <p><strong>首次:</strong> <span id="detail_first_time"></span></p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="adjustInventoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin.adjust_inventory_modal') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">調整庫存</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select name="product_id" class="form-select mb-3">
            {% for p in inventory_products %}
            <option value="{{ p.id }}">{{ p.name }} (現有:{{ p.stock_quantity }})</option>
            {% endfor %}
          </select>
          <label>變動數量 (+/-)</label>
          <input type="number" name="change_amount" class="form-control mb-3" required>
          <label>類型</label>
          <select name="change_type" class="form-select mb-3">
            <option value="adjustment">盤點調整</option>
            <option value="purchase">進貨</option>
            <option value="return">退貨</option>
          </select>
          <label>備註</label>
          <textarea name="notes" class="form-control"></textarea>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">提交</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editEventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editEventForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">編輯活動</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>標題</label><input name="title" id="edit_event_title" class="form-control">
          <label>開始</label><input name="start_date" id="edit_event_start" type="datetime-local" class="form-control">
          <label>結束</label><input name="end_date" id="edit_event_end" type="datetime-local" class="form-control">
          <label>描述</label><textarea name="description" id="edit_event_description" class="form-control"></textarea>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">更新</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addEventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin.add_event') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">新增活動</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>標題</label><input name="title" class="form-control" required>
          <label>開始</label><input name="start_date" type="datetime-local" class="form-control">
          <label>結束</label><input name="end_date" type="datetime-local" class="form-control">
          <label>描述</label><textarea name="description" class="form-control"></textarea>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button
            class="btn btn-primary">新增</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editCustomerForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">檢視/編輯客戶資料</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-6"><label class="form-label">姓</label><input name="surname" id="edit_cust_surname"
                class="form-control"></div>
            <div class="col-6"><label class="form-label">名</label><input name="firstname" id="edit_cust_firstname"
                class="form-control"></div>

            <div class="col-6"><label class="form-label">Email</label><input name="email" id="edit_cust_email"
                class="form-control"></div>
            <div class="col-6"><label class="form-label">電話</label><input name="phone" id="edit_cust_phone"
                class="form-control"></div>

            <div class="col-6"><label class="form-label">Line ID</label><input name="line_id" id="edit_cust_line_id"
                class="form-control"></div>
            <div class="col-6"><label class="form-label">職業</label><input name="occupation" id="edit_cust_occupation"
                class="form-control"></div>

            <div class="col-6"><label class="form-label">性別</label>
              <select name="gender" id="edit_cust_gender" class="form-select">
                <option value="female">女</option>
                <option value="male">男</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="col-6"><label class="form-label">生日</label><input name="birth_date" id="edit_cust_birth_date"
                type="date" class="form-control"></div>

            <div class="col-6"><label class="form-label">來源</label>
              <select name="source_id" id="edit_cust_source" class="form-select">
                <option value="">無</option>
                {% for s in customer_sources %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12"><label class="form-label">地址</label><input name="address" id="edit_cust_address"
                class="form-control"></div>

            <div class="col-12">
              <label class="form-label">備註</label>
              <textarea name="notes" id="edit_cust_notes" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary">更新</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('admin.add_customer') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title">手動新增客戶</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">帳號 *</label><input name="username" class="form-control"
                required></div>
            <div class="col-md-6"><label class="form-label">密碼 *</label><input name="password" type="password"
                class="form-control" required></div>
            <div class="col-md-6"><label class="form-label">姓氏 *</label><input name="surname" class="form-control"
                required></div>
            <div class="col-md-6"><label class="form-label">名字 *</label><input name="firstname" class="form-control"
                required></div>
            <div class="col-12"><label class="form-label">Email *</label><input name="email" type="email"
                class="form-control" required></div>

            <div class="col-md-6"><label class="form-label">電話</label><input name="phone" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Line ID</label><input name="line_id" class="form-control">
            </div>

            <div class="col-md-6"><label class="form-label">性別</label>
              <select name="gender" class="form-select">
                <option value="female" selected>女</option>
                <option value="male">男</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="col-md-6"><label class="form-label">生日</label><input name="birth_date" type="date"
                class="form-control"></div>

            <div class="col-md-6"><label class="form-label">職業</label><input name="occupation" class="form-control">
            </div>
            <div class="col-md-6"><label class="form-label">來源</label>
              <select name="source_id" class="form-select">
                <option value="">無</option>
                {% for s in customer_sources %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12"><label class="form-label">地址</label><input name="address" class="form-control"></div>

            <div class="col-12">
              <label class="form-label">備註</label>
              <textarea name="notes" class="form-control" rows="3" placeholder="例如：對精油過敏、喜歡重手感..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary">新增</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="restockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin.restock_product') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> 產品進貨入庫</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">選擇產品</label>
            <select name="product_id" class="form-select" required>
              <option value="">請選擇...</option>
              {% for p in inventory_products %}
              <option value="{{ p.id }}">{{ p.name }} (現有: {{ p.stock_quantity }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <div class="col-6 mb-3">
              <label class="form-label fw-bold">進貨數量</label>
              <input type="number" name="quantity" class="form-control" min="1" required>
            </div>
            <div class="col-6 mb-3">
              <label class="form-label">本次進貨成本 (單價)</label>
              <input type="number" name="cost" class="form-control" placeholder="選填，將更新成本">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">備註 / 批號</label>
            <textarea name="notes" class="form-control" rows="2" placeholder="例如: 廠商A, 批號20251201"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary px-4">確認進貨</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('admin.add_order_manual') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-cart-plus"></i> 建立或補登訂單</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">客戶</label>
              <select name="customer_id" class="form-select" required>
                <option value="">請選擇客戶...</option>
                {% for c in customers %}
                <option value="{{ c.id }}">{{ c.firstname }} {{ c.surname }} ({{ c.username }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">訂單日期</label>
              <input type="datetime-local" name="created_at" class="form-control" value="{{ now_str }}" required>
              <div class="form-text text-muted">若為補登歷史資料，請選擇過去日期。</div>
            </div>

            <div class="col-md-8">
              <label class="form-label fw-bold">產品</label>
              <select name="product_id" class="form-select" required>
                <option value="">請選擇產品...</option>
                {% for p in inventory_products %}
                <option value="{{ p.id }}" data-price="{{ p.price }}">
                  {{ p.name }} (庫存: {{ p.stock_quantity }}) - ${{ '{:,.0f}'.format(p.price) }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">數量</label>
              <input type="number" name="quantity" class="form-control" value="1" min="1" required>
            </div>

            <div class="col-12 mt-4">
              <div class="form-check form-switch p-3 bg-light rounded border">
                <input class="form-check-input" type="checkbox" name="send_notification" id="orderNotifSwitch" checked>
                <label class="form-check-label fw-bold" for="orderNotifSwitch">
                  <i class="bi bi-bell"></i> 發送確認通知 (LINE/Email)
                </label>
                <div class="small text-muted mt-1">
                  若是「補登歷史資料」，請<strong>取消勾選</strong>以免打擾客戶。<br>
                  若是「代客下單」，保持勾選，系統將直接發送「已確認」通知。
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">建立訂單</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addBookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('admin.add_booking_manual') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> 建立或補登預約</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">客戶</label>
              <select name="customer_id" class="form-select" required>
                <option value="">請選擇客戶...</option>
                {% for c in customers %}
                <option value="{{ c.id }}">{{ c.firstname }} {{ c.surname }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">課程</label>
              <select name="course_id" class="form-select" required>
                <option value="">請選擇課程...</option>
                {% for c in courses %}
                <option value="{{ c.id }}">{{ c.name }} ({{ c.duration }}分)</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">預約時間</label>
              <input type="datetime-local" name="appointment_time" class="form-control" required>
              <div class="form-text">可選擇過去時間進行補登。</div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">扣除/購買堂數</label>
              <input type="number" name="sessions" class="form-control" value="1" min="1" required>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_first_time" id="isFirstTime">
                <label class="form-check-label" for="isFirstTime">這是該客戶首次體驗 (適用體驗價)</label>
              </div>
            </div>

            <div class="col-12 mt-3">
              <div class="form-check form-switch p-3 bg-light rounded border">
                <input class="form-check-input" type="checkbox" name="send_notification" id="bookingNotifSwitch"
                  checked>
                <label class="form-check-label fw-bold" for="bookingNotifSwitch">
                  <i class="bi bi-bell"></i> 發送確認通知 (LINE/Email)
                </label>
                <div class="small text-muted mt-1">
                  補登歷史資料請<strong>取消勾選</strong>。<br>
                  代客預約保持勾選，系統將直接發送「預約成功」通知。
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">建立預約</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Helper: preview image
  function previewImage(input, previewId) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) { document.getElementById(previewId).src = e.target.result; };
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Edit Product Modal
  function fetchProductData(productId) {
    // 1. 呼叫 API
    fetch(`/admin/api/product/${productId}`)
      .then(response => response.json())
      .then(product => {
        if (product.error) {
          alert('找不到產品資料');
          return;
        }

        // --- 定義安全填值函式 (防止 Staff 找不到 Cost 欄位報錯) ---
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = (val === null || val === undefined) ? '' : val;
        };

        // 2. 填入資料 (使用 setVal)
        setVal('edit_product_name', product.name);
        setVal('edit_product_category', product.category_id);
        setVal('edit_product_price', product.price);
        setVal('edit_product_cost', product.cost); // ⭐ 這樣 Staff 就不會報錯了
        setVal('edit_product_stock', product.stock_quantity);
        setVal('edit_product_unit', product.unit);
        setVal('edit_product_description', product.description);

        // 3. 處理圖片與特殊欄位
        setVal('edit_product_current_image', product.image);

        const previewEl = document.getElementById('editProductPreview');
        if (previewEl) {
          // 修正圖片路徑拼接邏輯
          var staticBase = "{{ url_for('static', filename='') }}";
          // 如果 API 回傳的 image 已經包含 img/ 前綴，直接接上
          var imgPath = product.image ? (staticBase + product.image) : (staticBase + 'img/placeholder.jpg');
          previewEl.src = imgPath;
        }

        const activeEl = document.getElementById('edit_product_is_active');
        if (activeEl) {
          activeEl.checked = (product.is_active == 1 || product.is_active == true);
        }

        // 4. 設定 Form Action
        const formEl = document.getElementById('editProductForm');
        if (formEl) {
          let url = "{{ url_for('admin.update_product_modal', product_id=0) }}";
          formEl.action = url.replace('/0/', '/' + productId + '/');
        }

        // 5. 顯示 Modal
        new bootstrap.Modal(document.getElementById('editProductModal')).show();
      })
      .catch(error => {
        console.error('JS Error:', error);
        alert('資料讀取發生錯誤，請查看 Console');
      });
  }

  // ================= 課程編輯 (AJAX版) =================
  function fetchCourseData(courseId) {
    fetch(`/admin/api/course/${courseId}`)
      .then(response => response.json())
      .then(course => {
        if (course.error) {
          alert('找不到課程資料');
          return;
        }

        // Helper: 安全填值
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = (val === null || val === undefined) ? '' : val;
        };

        setVal('edit_course_name', course.name);
        setVal('edit_course_category', course.category_id);
        setVal('edit_course_regular_price', course.regular_price);
        setVal('edit_course_experience_price', course.experience_price);

        // ⭐ 填入成本 (自動判斷欄位是否存在)
        setVal('edit_course_service_fee', course.service_fee);
        setVal('edit_course_product_fee', course.product_fee);

        setVal('edit_course_duration', course.duration);
        setVal('edit_course_sessions', course.sessions);
        setVal('edit_course_description', course.description);

        // 圖片
        setVal('edit_course_current_image', course.image);
        var imgPath = course.image ? ("{{ url_for('static', filename='') }}" + course.image) : "{{ url_for('static', filename='img/placeholder.jpg') }}";
        const preview = document.getElementById('editCoursePreview');
        if (preview) preview.src = imgPath;

        const activeEl = document.getElementById('edit_course_is_active');
        if (activeEl) activeEl.checked = !!course.is_active;

        // 設定 Action
        const formEl = document.getElementById('editCourseForm');
        if (formEl) {
          let url = "{{ url_for('admin.update_course_modal', course_id=0) }}";
          formEl.action = url.replace('/0/', '/' + courseId + '/');
        }

        // 顯示
        new bootstrap.Modal(document.getElementById('editCourseModal')).show();
      })
      .catch(error => {
        console.error('JS Error:', error);
        alert('無法讀取課程資料');
      });
  }

  // Edit Course Modal
  // ================= Edit Course Modal (完整修正版) =================
  function openEditCourseModal(course) {
    // 確保 course 是個物件，避免 undefined 報錯
    course = course || {};

    // 1. 填入基本欄位
    document.getElementById('edit_course_name').value = course.name || '';
    document.getElementById('edit_course_category').value = course.category_id || '';
    document.getElementById('edit_course_regular_price').value = course.regular_price || '';
    document.getElementById('edit_course_experience_price').value = course.experience_price || '';
    document.getElementById('edit_course_duration').value = course.duration || '';
    document.getElementById('edit_course_sessions').value = course.sessions || 1;
    document.getElementById('edit_course_description').value = course.description || '';

    // 2. ⭐ 關鍵修正：填入成本欄位前，先檢查欄位是否存在
    // 這是為了防止 Staff 登入時 (HTML 沒這欄位) 導致 JS 報錯

    // 服務成本
    var serviceEl = document.getElementById('edit_course_service_fee');
    if (serviceEl) {
      serviceEl.value = course.service_fee || 0;
    }

    // 產品成本 (這是 Admin 才有的，Staff 會是 null)
    var productEl = document.getElementById('edit_course_product_fee');
    if (productEl) {
      productEl.value = course.product_fee || 0;
    }

    // 3. 處理圖片預覽與路徑
    document.getElementById('edit_course_current_image').value = course.image || '';

    // 設定圖片路徑 (如果沒圖就顯示 placeholder)
    var staticBase = "{{ url_for('static', filename='') }}";
    var imgPath = course.image ? (staticBase + course.image) : (staticBase + "img/placeholder.jpg");
    document.getElementById('editCoursePreview').src = imgPath;

    // 4. 設定啟用狀態 (Checkbox)
    document.getElementById('edit_course_is_active').checked = !!course.is_active;

    // 5. 設定表單提交網址 (Action URL)
    if (course.id) {
      let url = "{{ url_for('admin.update_course_modal', course_id=0) }}";
      document.getElementById('editCourseForm').action = url.replace('/0/', '/' + course.id + '/');
    }

    // 6. 顯示 Modal
    new bootstrap.Modal(document.getElementById('editCourseModal')).show();
  }

  // ================= Schedule Manager (AJAX) =================

  // 1. 開啟 Modal 並載入時段列表
  function openCapacityModal(courseId, courseName) {
    document.getElementById('cap_course_name').textContent = courseName;
    const tbody = document.getElementById('scheduleListBody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>';

    new bootstrap.Modal(document.getElementById('capacityModal')).show();

    // 呼叫後端 API 獲取時段
    fetch(`/admin/api/course/${courseId}/schedules`)
      .then(res => res.json())
      .then(data => {
        tbody.innerHTML = ''; // 清空 Loading

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">未來 30 天無排程時段</td></tr>';
          return;
        }

        data.forEach(slot => {
          // 判斷是否額滿樣式
          let badgeClass = slot.current_bookings >= slot.max_capacity ? 'bg-danger' : 'bg-success';

          let row = `
                <tr>
                    <td class="ps-4 fw-bold">${slot.date}</td>
                    <td>${slot.time}</td>
                    <td class="text-center">
                        <span class="badge ${badgeClass}">${slot.current_bookings}</span>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center" 
                               id="cap_input_${slot.id}" value="${slot.max_capacity}" min="1">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="saveSlotCapacity(${slot.id})">
                            <i class="bi bi-save"></i> 儲存
                        </button>
                    </td>
                </tr>
            `;
          tbody.insertAdjacentHTML('beforeend', row);
        });
      })
      .catch(err => {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">載入失敗，請重試</td></tr>';
      });
  }

  // 2. 儲存單一時段設定
  function saveSlotCapacity(scheduleId) {
    const input = document.getElementById(`cap_input_${scheduleId}`);
    const newCap = input.value;
    const btn = input.closest('tr').querySelector('button');

    // UI Loading 狀態
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch(`/admin/schedule/${scheduleId}/update-capacity`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': "{{ csrf_token() }}" // 確保 CSRF Token 存在
      },
      body: JSON.stringify({ max_capacity: newCap })
    })
      .then(res => res.json())
      .then(data => {
        btn.disabled = false;
        if (data.success) {
          // 成功提示 (變綠勾勾一下)
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');
          btn.innerHTML = '<i class="bi bi-check-lg"></i>';
          setTimeout(() => {
            btn.innerHTML = '<i class="bi bi-save"></i> 儲存';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
          }, 1500);
        } else {
          alert('更新失敗: ' + data.message);
          btn.innerHTML = originalContent;
        }
      })
      .catch(err => {
        alert('連線錯誤');
        btn.disabled = false;
        btn.innerHTML = originalContent;
      });
  }


  // Order Detail
  function openOrderDetailModal(order) {
    document.getElementById('order_detail_id').innerText = order.id;
    document.getElementById('order_detail_customer').innerText = order.customer_name;
    document.getElementById('order_detail_email').innerText = order.email;
    document.getElementById('order_detail_phone').innerText = order.phone;
    document.getElementById('order_detail_total').innerText = order.total_amount;

    let tbody = document.getElementById('order_detail_items');
    tbody.innerHTML = '';
    if (order.items) {
      order.items.forEach(item => {
        let row = `<tr><td>${item.product_name}</td><td>${item.unit_price}</td><td>${item.quantity}</td><td>${item.subtotal}</td></tr>`;
        tbody.innerHTML += row;
      });
    }
    new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
  }

  // Booking Detail
  function openBookingDetailModal(bk) {
    document.getElementById('detail_id').innerText = bk.id;
    document.getElementById('detail_customer').innerText = bk.customer_name;
    document.getElementById('detail_phone').innerText = bk.phone;
    document.getElementById('detail_email').innerText = bk.email;
    document.getElementById('detail_course').innerText = bk.course_name;
    document.getElementById('detail_time').innerText = bk.time_str;
    document.getElementById('detail_duration').innerText = bk.duration;
    document.getElementById('detail_sessions').innerText = bk.sessions_purchased;
    document.getElementById('detail_remaining').innerText = bk.sessions_remaining;
    document.getElementById('detail_amount').innerText = bk.total_amount;
    document.getElementById('detail_first_time').innerText = bk.is_first_time ? '是' : '否';
    new bootstrap.Modal(document.getElementById('bookingDetailModal')).show();
  }

  // Adjust Inventory
  function openAdjustModal(pid) {
    document.querySelector('select[name="product_id"]').value = pid;
    new bootstrap.Modal(document.getElementById('adjustInventoryModal')).show();
  }

  // Edit Event
  function openEditEventModal(evt) {
    document.getElementById('edit_event_title').value = evt.title;
    // Format date for datetime-local (yyyy-MM-ddThh:mm)
    let format = (d) => d ? d.replace(' ', 'T').substring(0, 16) : '';
    document.getElementById('edit_event_start').value = format(evt.start_date);
    document.getElementById('edit_event_end').value = format(evt.end_date);
    document.getElementById('edit_event_description').value = evt.description;

    let url = "{{ url_for('admin.update_event', event_id=0) }}";
    document.getElementById('editEventForm').action = url.replace('/0/', '/' + evt.id + '/');
    new bootstrap.Modal(document.getElementById('editEventModal')).show();
  }

  // Edit Customer
  function openEditCustomerModal(cust) {
    // 填入基本資料
    document.getElementById('edit_cust_surname').value = cust.surname || '';
    document.getElementById('edit_cust_firstname').value = cust.firstname || '';
    document.getElementById('edit_cust_email').value = cust.email || '';
    document.getElementById('edit_cust_phone').value = cust.phone || '';
    document.getElementById('edit_cust_line_id').value = cust.line_id || '';
    document.getElementById('edit_cust_occupation').value = cust.occupation || '';
    document.getElementById('edit_cust_gender').value = cust.gender || 'female';
    document.getElementById('edit_cust_birth_date').value = cust.birth_date || '';
    document.getElementById('edit_cust_source').value = cust.source_id || '';

    // ⭐ 修正 1：這裡原本寫 data.notes，要改成 cust.notes
    document.getElementById('edit_cust_notes').value = cust.notes || '';
    document.getElementById('edit_cust_address').value = cust.address || '';

    // ⭐ 修正 2：網址替換建議去掉後面的斜線，寫 '/0' 就好，這樣相容性最高
    let url = "{{ url_for('admin.update_customer', customer_id=0) }}";
    document.getElementById('editCustomerForm').action = url.replace('/0', '/' + cust.id);

    // 顯示 Modal
    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
  }

  function openRestockModal(pid) {
    var modal = new bootstrap.Modal(document.getElementById('restockModal'));
    modal.show();
    var select = document.querySelector('#restockModal select[name="product_id"]');
    if (select) select.value = pid;
  }

</script>
{% endblock %}